<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>åµã‚­ãƒ£ãƒƒãƒã‚²ãƒ¼ãƒ  - ç©¶æ¥µç‰ˆ</title> {/* ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´ */}
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
    body { width: 100vw; height: 100vh; overflow: hidden; font-family: 'Noto Sans JP', sans-serif; touch-action: manipulation; -webkit-overflow-scrolling: touch; margin: 0; }
    #page-wrapper { width: 100%; height: 100%; background-color: #3c2f2f; /* å°‘ã—èŒ¶è‰²ã£ã½ã„é»’ */ display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; }
    #game-container {
      position: relative; width: 100%;
      max-width: 400px;
      height: 100%;
      background: linear-gradient(135deg, #fffacd 0%, #f5deb3 50%, #ffe4b5 100%); /* åµã£ã½ã„æš–è‰²ç³»ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
      overflow: hidden;
      box-shadow: 0 0 20px rgba(255,235,205,0.5);
    }
    .bg-particle { /* ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠå†…ã®èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ (åµã®é»„èº«ã‚„ç™½èº«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼Ÿ) */
      position: absolute;
      background: rgba(255, 215, 0, 0.15); /* è–„ã„é»„è‰² */
      border-radius: 50%;
      pointer-events: none;
      animation: float-bg linear infinite;
      z-index: 1;
    }
    .bg-particle.white { background: rgba(255, 250, 240, 0.1); } /* ç™½ã£ã½ã„ã®ã‚‚è¿½åŠ  */

    @keyframes float-bg { 0% { transform: translateY(100%) rotate(0deg) scale(0.5) opacity: 0; } 20% { opacity: 0.5; } 80% { opacity: 0.5; } 100% { transform: translateY(-100px) rotate(360deg) scale(1.5) opacity: 0; } }
    
    .outer-sakura-particle { /* å¤–å´ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¯ã€Œç¾½ã€ã‚„ã€Œè—ã€ãªã©ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã¦å¤‰æ›´ã‚‚å¯ */
        position: absolute;
        /* background-image: url('feather.png');  ã‚‚ã—ç¾½ç”»åƒãªã©ã‚ã‚Œã° */
        background-color: rgba(160, 82, 45, 0.4); /* è—ã‚„æœ¨ã®æã®ã‚ˆã†ãªèŒ¶è‰²ç³» */
        width: 3px; height: 20px; border-radius: 2px;
        pointer-events: none; animation: fall-outer-sakura linear infinite; opacity: 0; z-index: 5;
    }
    @keyframes fall-outer-sakura {
        0% { transform: translateY(-10vh) translateX(var(--outer-start-x)) rotateZ(var(--outer-rotate-z-start)); opacity: 0; }
        10% { opacity: 0.7; }
        90% { opacity: 0.7; }
        100% { transform: translateY(110vh) translateX(var(--outer-end-x)) rotateZ(var(--outer-rotate-z-end)); opacity: 0; }
    }

    #character { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); max-height: 25vh; max-width: 120px; height: auto; z-index: 50; filter: drop-shadow(2px 4px 8px rgba(0,0,0,0.2)); }
    #character.jump { animation: jump 0.6s ease; }
    #character.powerup { filter: drop-shadow(0 0 15px #FFD700) drop-shadow(2px 4px 8px rgba(0,0,0,0.2)); transform: translateX(-50%) scale(1.1); transition: transform 0.2s ease-out, filter 0.2s ease-out; }
    @keyframes jump { 0% { transform: translateX(-50%) translateY(0); } 30% { transform: translateX(-50%) translateY(-60px); } 60% { transform: translateX(-50%) translateY(-60px); } 100% { transform: translateX(-50%) translateY(0); } }

    /* ã‚¢ã‚¤ãƒ†ãƒ å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .egg, .bomb, .power-up, .time-plus, .helper-mgchan { position: absolute; pointer-events: none; z-index: 40; }

    /* â˜…â˜…â˜… ãƒ¡ã‚¤ãƒ³ã®åµã‚¢ã‚¤ãƒ†ãƒ  â˜…â˜…â˜… */
    .egg { /* æ—§ .petal */
      width: 30px; height: 40px; /* åµã‚‰ã—ã„ç¸¦æ¨ªæ¯” */
      background-image: url('egg.png'); /* åµã®ç”»åƒã‚’æŒ‡å®š */
      background-color: transparent;
      background-repeat: no-repeat; background-position: center; background-size: contain;
      animation: fall-egg linear; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åå¤‰æ›´ */
      filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.2));
    }
    .egg.special { /* æ—§ .petal.special - è¦‹ãŸç›®ã¯å¤‰æ›´ãŒå¿…è¦ãªã‚‰ */
      width: 35px; height: 45px; background: radial-gradient(circle, #FFD700 0%, #FFA500 50%, #FF69B4 100%);
      filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8)); animation: fall-special-egg linear; border-radius:40% 40% 35% 35%/50% 50% 45% 45%; /* åµã£ã½ã„å½¢ */
    }
    .egg.golden { /* æ—§ .petal.golden - è¦‹ãŸç›®ã¯å¤‰æ›´ãŒå¿…è¦ãªã‚‰ */
      width: 40px; height: 50px; background: radial-gradient(circle, #FFD700 0%, #FFFF00 30%, #FFA500 70%, #FF4500 100%);
      filter: drop-shadow(0 0 15px rgba(255, 215, 0, 1)) drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
      animation: fall-golden-egg linear; border: 2px solid rgba(255, 218, 185, 0.9); border-radius:45% 45% 40% 40%/55% 55% 40% 40%; /* åµã£ã½ã„å½¢ */
    }
    /* â˜…â˜…â˜… MG Chan åŠ©ã£äººã‚¢ã‚¤ãƒ†ãƒ  â˜…â˜…â˜… */
    .helper-mgchan {
      width: 60px; height: 60px; /* ç”»åƒã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦èª¿æ•´ */
      background-image: url('MG Chan.jpg');
      background-color: transparent;
      background-repeat: no-repeat; background-position: center; background-size: contain;
      animation: fall-helper linear;
      border-radius: 50%; /* ä¸¸ãè¡¨ç¤ºã™ã‚‹å ´åˆ */
      filter: drop-shadow(0px 3px 5px rgba(0,0,0,0.3));
    }

    .bomb { width: 40px; height: 40px; background: radial-gradient(circle, #702010 0%, #401008 70%, #200804 100%); /* èŒ¶è‰²ã£ã½ã„çˆ†å¼¾ï¼Ÿ */ border-radius: 50%; filter: drop-shadow(0 0 10px rgba(80, 0, 0, 0.8)); animation: fall-bomb linear; }
    .bomb::before { content: 'ğŸ’£'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 25px; animation: bomb-pulse 0.5s infinite alternate; }
    @keyframes bomb-pulse { 0% { transform: translate(-50%, -50%) scale(1); } 100% { transform: translate(-50%, -50%) scale(1.2); } }
    .power-up { width: 45px; height: 45px; background: linear-gradient(45deg, #FFD700, #FFA500, #FF8C00, #FF7F50, #FF6347); border-radius: 50%; filter: drop-shadow(0 0 15px rgba(255,165,0,0.8)); animation: fall-powerup linear; animation-name: fall-powerup, rainbow-rotate-warm; animation-duration: inherit, 1.5s; animation-iteration-count: 1, infinite; animation-timing-function: linear, ease-in-out; }
    .power-up::before { content: 'ğŸ”¥'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 25px; animation: star-spin 1.5s linear infinite; } /* ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´ */
    .time-plus { width: 40px; height: 40px; background: radial-gradient(circle, #ADD8E6 0%, #87CEEB 50%, #5F9EA0 100%); /* æ°´è‰²ç³» */ border-radius: 50%; filter: drop-shadow(0 0 8px rgba(135,206,250,0.7)); animation: fall-time-plus linear; }
    .time-plus::before { content: 'âŒ›ï¸'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 25px; animation: time-pulse 1.5s ease-in-out infinite alternate; }

    @keyframes time-pulse { 0% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0.7; } 50% { transform: translate(-50%, -50%) scale(1.1) rotate(10deg); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0.7; } }
    @keyframes star-spin { 0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); } 50% { transform: translate(-50%, -50%) rotate(180deg) scale(1.2); } 100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); } }
    @keyframes rainbow-rotate-warm { /* æš–è‰²ç³»ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ */
        0% { filter: drop-shadow(0 0 15px rgba(255,165,0,0.8)) hue-rotate(0deg); }
        100% { filter: drop-shadow(0 0 15px rgba(255,165,0,0.8)) hue-rotate(60deg); } /* èµ¤ï½é»„è‰²ç³»ã®ç¯„å›²ã§ */
    }

    /* â˜…â˜…â˜… åµç”¨ã®è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ â˜…â˜…â˜… */
    @keyframes fall-egg {
      0% { transform: translateY(-60px) rotateZ(0deg); opacity: 0.7; }
      100% { transform: translateY(105vh) rotateZ(calc(var(--random-rotate) * 1deg)); opacity: 1; } /* å°‘ã—å›è»¢ */
    }
    @keyframes fall-special-egg { /* ç‰¹æ®Šãªåµã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      0% { transform: translateY(-50px) rotateZ(0deg) scale(0.9); opacity: 0.8; }
      50% { transform: translateY(50vh) rotateZ(180deg) scale(1.1); }
      100% { transform: translateY(105vh) rotateZ(360deg) scale(0.9); opacity: 1; }
    }
    @keyframes fall-golden-egg { /* é‡‘è‰²ã®åµã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      0% { transform: translateY(-50px) rotateZ(0deg) scale(1); opacity: 0.9; }
      25% { transform: translateY(25vh) rotateZ(var(--random-rotate-half) * 1deg) scale(1.1); }
      100% { transform: translateY(105vh) rotateZ(var(--random-rotate) * 1deg) scale(1); opacity: 1; }
    }
    @keyframes fall-helper { /* MG Chan ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      0% { transform: translateY(-70px) scale(0.8) rotate(-10deg); opacity: 0.7; }
      50% { transform: translateY(40vh) scale(1.1) rotate(10deg); opacity: 1; }
      100% { transform: translateY(105vh) scale(0.9) rotate(5deg); opacity: 0.8; }
    }
    /* æ—¢å­˜ã®fall-bomb, fall-powerup, fall-time-plus ã¯ãã®ã¾ã¾åˆ©ç”¨ */
    @keyframes fall-bomb { 0% { transform: translateY(-50px) rotate(0deg) scale(1); opacity: 1; } 30% { transform: translateY(30vh) rotate(-20deg) scale(1.05); } 60% { transform: translateY(60vh) rotate(15deg) scale(1.1); } 100% { transform: translateY(100vh) rotate(10deg) scale(1); opacity: 1; } }
    @keyframes fall-powerup { 0% { transform: translateY(-50px) scale(0.8); opacity: 0.8; } 25% { opacity: 1; transform: translateY(25vh) scale(1.1); } 50% { transform: translateY(50vh) scale(1.2); } 75% { transform: translateY(75vh) scale(1.1); } 100% { transform: translateY(100vh) scale(1); opacity: 1; } }
    @keyframes fall-time-plus { 0% { transform: translateY(-50px) translateX(0px) rotate(0deg) scale(0.9); opacity: 0.7;} 25% { opacity: 1; transform: translateY(25vh) translateX(10px) rotate(5deg) scale(1);} 50% { transform: translateY(50vh) translateX(-10px) rotate(-5deg) scale(1.1);} 75% { transform: translateY(75vh) translateX(5px) rotate(2deg) scale(1);} 100% { transform: translateY(100vh) translateX(0px) rotate(0deg) scale(0.9); opacity: 1;} }


    #scoreboard, #level-display, .control-btn, .power-effect, .combo-display, .level-up-effect { position: fixed; z-index: 200; }
    #scoreboard { top: 15px; right: 20px; font-size: 14px; font-weight: bold; color: #604020; background: linear-gradient(145deg, #fff8dc 0%, #ffefd5 100%); padding: 15px 20px; border-radius: 20px; line-height: 1.6; box-shadow: 0 8px 24px rgba(0,0,0,0.1), 0 4px 8px rgba(139,69,19,0.2); border: 2px solid rgba(210,180,140,0.5); backdrop-filter: blur(10px); min-width: 180px; }
    #level-display { top: 15px; left: 20px; font-size: 16px; font-weight: bold; color: #604020; background: linear-gradient(145deg, #fff8dc 0%, #ffefd5 100%); padding: 12px 18px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1), 0 2px 4px rgba(139,69,19,0.2); border: 2px solid rgba(210,180,140,0.5); backdrop-filter: blur(5px); }
    .combo-display { top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: bold; color: #FF8C00; background: rgba(60,30,10, 0.85); padding: 10px 20px; border-radius: 15px; display: none; animation: combo-pop 1s ease-out; text-shadow: 1px 1px 2px rgba(255,255,255,0.3); z-index: 210; }
    #gameover { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; font-weight: bold; background: linear-gradient(145deg, rgba(80,50,20,0.9), rgba(50,30,10,0.85)); color: #fff8dc; padding: 30px; border-radius: 20px; display: none; z-index: 150; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 2px solid rgba(210,180,140,0.3); width: 90%; max-width: 380px; }
    #return-to-select-btn { background-color: #D2691E; color: white; border: none; padding: 12px 25px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin-top: 25px; cursor: pointer; border-radius: 8px; transition: background-color 0.3s ease; }
    #return-to-select-btn:hover { background-color: #A0522D; }
    .control-btn { bottom: 15px; width: 55px; height: 55px; font-size: 22px; border-radius: 50%; border: none; background: linear-gradient(145deg, rgba(210,180,140,0.9) 0%, rgba(139,69,19,0.8) 100%); color: white; touch-action: manipulation; -webkit-tap-highlight-color: transparent; cursor: pointer; box-shadow: 0 6px 18px rgba(139,69,19,0.4), 0 3px 6px rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.4); transition: all 0.2s ease; }
    .control-btn:active { transform: scale(0.95); box-shadow: 0 3px 9px rgba(139,69,19,0.4), 0 1px 3px rgba(0,0,0,0.2); }
    .power-effect { bottom: 150px; left: 20px; background: linear-gradient(45deg, #FFA500, #FF4500); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; display: none; animation: power-glow 0.5s ease-in-out infinite alternate; }
    .level-up-effect { top: 30%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; font-weight: bold; color: #CD853F; background: linear-gradient(45deg, rgba(255,228,181,0.9), rgba(255,218,185,0.8)); padding: 20px 40px; border-radius: 20px; display: none; animation: level-up-animation 2s ease-out; text-shadow: 1px 1px 2px rgba(100,50,0,0.5); border: 3px solid rgba(255,255,255,0.8); z-index: 210;}
    /* ãã®ä»–ã® @keyframes ã¯å‰å›ã¨åŒæ§˜ */
  </style>
</head>
<body>
  <div id="page-wrapper">
    <div id="game-container">
      <img id="character" src="" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼">
      <div id="gameover">
        <div>ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</div>
        <div style="font-size: 18px; margin-top: 10px;">
          æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="final-score">0</span><br>
          åˆ°é”ãƒ¬ãƒ™ãƒ«: <span id="final-level">1</span>
        </div>
        <button id="return-to-select-btn">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã«æˆ»ã‚‹</button>
      </div>
      <div class="combo-display" id="combo-display"></div>
      <div class="level-up-effect" id="level-up-effect"></div>
      <div class="power-effect" id="power-effect"></div>
    </div>
  </div>

  <div id="scoreboard"> ã‚¹ã‚³ã‚¢: <span id="score">0</span><br> ãƒã‚¤ã‚¹ã‚³ã‚¢: <span id="highscore">0</span><br> æ®‹ã‚Š: <span id="timer">60</span>ç§’<br> ã‚³ãƒ³ãƒœ: <span id="combo">0</span> </div>
  <div id="level-display"> ãƒ¬ãƒ™ãƒ«: <span id="level">1</span> </div>

  <script>
    document.addEventListener('contextmenu', e => { e.preventDefault(); return false; }, { passive: false });
    document.addEventListener('selectstart', e => { e.preventDefault(); return false; }, { passive: false });
    document.addEventListener('dragstart', e => { e.preventDefault(); return false; }, { passive: false });

    const pageWrapper = document.getElementById("page-wrapper");
    const gameContainer = document.getElementById("game-container");
    const character = document.getElementById("character");
    const scoreDisplay = document.getElementById("score");
    const highscoreDisplay = document.getElementById("highscore");
    const timerDisplay = document.getElementById("timer");
    const levelDisplay = document.getElementById("level");
    const comboDisplay = document.getElementById("combo");
    const comboPopup = document.getElementById("combo-display");
    const powerEffect = document.getElementById("power-effect");
    const levelUpEffect = document.getElementById("level-up-effect");
    const gameover = document.getElementById("gameover");
    const finalScore = document.getElementById("final-score");
    const finalLevel = document.getElementById("final-level");
    const returnToSelectBtn = document.getElementById("return-to-select-btn");

    const selectedImageFile = localStorage.getItem("selectedImage");
    const selectedCharName = localStorage.getItem("selectedName");

    if (selectedImageFile && selectedCharName) {
      character.src = selectedImageFile;
      character.alt = selectedCharName;
    } else {
      character.src = "hide.jpg"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚­ãƒ£ãƒ©ã‚’hide.jpgã«
      character.alt = "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼H";
    }

    let score = 0; let highscore = 0; let timeLeft = 60;
    const MAX_TIME_LEFT = 90; const MAX_LEVEL = 5; let level = 1;
    const levelThresholds = [0, 30, 80, 150, 250]; // ã“ã®å€¤ã§ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—èª¿æ•´
    let combo = 0; let maxCombo = 0; let itemSpawnerId;
    let gameBgParticleInterval; let outerEffectInterval; // åå‰å¤‰æ›´
    let isPowerUpActive = false; let powerUpEndTime = 0;
    let characterX;

    let seEggCollect, bgm, seTimePlus, seBomb, sePowerUp, seHelperMG; // åŠ¹æœéŸ³å¤‰æ•°åå¤‰æ›´
    try {
      seEggCollect = new Audio("kirarin.mp3"); // åµå–å¾—éŸ³ (ä»®ã«kirarin.mp3ã‚’æµç”¨)
      bgm = new Audio("bgm.mp3");
      seTimePlus = new Audio("tm.mp3");
      seBomb = new Audio("bom.mp3");
      sePowerUp = new Audio("st.mp3");
      seHelperMG = new Audio("mg_chan_effect.mp3"); // MG ChanåŠ¹æœéŸ³ (ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦ãã ã•ã„)

      bgm.loop = true; bgm.volume = 0.3;
    } catch (error) {
      console.error("ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®åˆæœŸåŒ–ã«å¤±æ•—: ", error);
      seEggCollect = { play: () => {}, currentTime: 0 };
      bgm = { play: () => Promise.resolve(), loop: true, volume: 0.3 };
      seTimePlus = { play: () => {}, currentTime: 0 }; seBomb = { play: () => {}, currentTime: 0 };
      sePowerUp = { play: () => {}, currentTime: 0 }; seHelperMG = { play: () => {}, currentTime: 0 };
    }
    try { highscore = parseInt(localStorage.getItem("eggCatchGameHighscore")) || 0; } // ã‚­ãƒ¼åå¤‰æ›´
    catch (error) { console.warn("ãƒã‚¤ã‚¹ã‚³ã‚¢èª­ã¿è¾¼ã¿å¤±æ•—:", error); }
    highscoreDisplay.innerText = highscore;

    function createBackgroundParticle() { /* ... (å‰å›ã¨åŒæ§˜ã€gameContainerã«è¿½åŠ ) ... */ }
    function createOuterEffectParticle() { /* ... (å‰å› outerSakuraParticle ã¨åŒæ§˜ã€pageWrapperã«è¿½åŠ ) ... */ }
    // ä¸Šè¨˜2ã¤ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«é–¢æ•°ã¯ã€è¦‹ãŸç›®ã‚’åµãƒ†ãƒ¼ãƒã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
    // ä»¥ä¸‹ã¯ createOuterEffectParticle ã®ä¾‹ (å°‘ã—æŠ½è±¡çš„ãªå…‰ã®ç²’ãªã©)
    function createOuterEffectParticle() {
        if(!pageWrapper) return;
        const particle = document.createElement('div');
        // particle.className = 'outer-sakura-particle'; // åˆ¥ã®ã‚¯ãƒ©ã‚¹åã§ã‚‚è‰¯ã„
        particle.style.position = 'absolute';
        particle.style.backgroundColor = `hsla(${Math.random() * 60 + 200}, 70%, 70%, 0.5)`; // é’ï½ç´«ç³»ã®å…‰
        particle.style.width = `${Math.random() * 3 + 1}px`;
        particle.style.height = particle.style.width;
        particle.style.borderRadius = '50%';
        particle.style.pointerEvents = 'none';
        particle.style.zIndex = '5';
        particle.style.opacity = '0';

        const startX = `${Math.random() * 100}vw`;
        const duration = Math.random() * 8 + 7; // 7-15ç§’
        particle.style.left = startX;
        particle.style.top = '-5px';

        particle.animate([
            { transform: `translateY(-5vh) translateX(0vw) scale(0.5)`, opacity: 0 },
            { opacity: 1, transform: `translateY(50vh) translateX(${(Math.random()-0.5)*20}vw) scale(1)`},
            { transform: `translateY(105vh) translateX(${(Math.random()-0.5)*40}vw) scale(0.5)`, opacity: 0 }
        ], {
            duration: duration * 1000,
            delay: Math.random() * 5000,
            easing: 'linear',
            iterations: 1 // 1å›å†ç”Ÿã—ã¦æ¶ˆãˆã‚‹
        });
        pageWrapper.appendChild(particle);
        setTimeout(() => { if(particle.parentNode) particle.remove(); }, (duration * 1000) + (Math.random() * 5000) + 100);
    }


    function updateCharacterPosition() { character.style.left = `${characterX}px`; }
    function calculateLevel() { let newLvl = 1; for (let i=0; i<levelThresholds.length; i++) { if (score >= levelThresholds[i]) newLvl = i + 1; else break; } return Math.min(newLvl, MAX_LEVEL); }
    function getSpawnRate() { return Math.max(150, 700 - (level * 40)); }

    function updateScore(points = 1) {
      const previousLevel = level;
      if (isPowerUpActive) points *= 2;
      score += points; combo++;
      scoreDisplay.innerText = score; comboDisplay.innerText = combo;
      level = calculateLevel(); levelDisplay.innerText = level;
      if (level > previousLevel) {
        if (level === MAX_LEVEL && previousLevel < MAX_LEVEL) { showLevelUp(`MAX LEVEL ${MAX_LEVEL} åˆ°é”!`); }
        else if (level < MAX_LEVEL) { showLevelUp(`LEVEL ${level}!`); }
      }
      if (combo > 1) showComboPopup(); if (combo > maxCombo) maxCombo = combo;
      // åµå–å¾—éŸ³ã¯ checkCollision å†…ã§å†ç”Ÿ
      if (points >= 5) showSpecialEffect(); // é‡‘è‰²ã®åµãªã©ã®å ´åˆ
    }

    function resetCombo() { combo = 0; comboDisplay.innerText = combo; }
    function showComboPopup() { comboPopup.textContent = `${combo} COMBO!`; comboPopup.style.display = 'block'; setTimeout(() => { comboPopup.style.display = 'none'; }, 1000); }
    function showLevelUp(message = `LEVEL ${level}!`) { levelUpEffect.textContent = message; levelUpEffect.style.display = 'block'; setTimeout(() => { levelUpEffect.style.display = 'none'; }, 2000); }
    function showSpecialEffect() { scoreDisplay.style.transform = 'scale(1.3)'; scoreDisplay.style.color = '#D4AF37'; /* é‡‘è‰²ã£ã½ã */ setTimeout(() => { scoreDisplay.style.transform = 'scale(1)'; scoreDisplay.style.color = '#604020'; }, 500); }
    let powerUpTimerId = null;
    function activatePowerUp() { /* ... (å‰å›ã¨åŒæ§˜) ... */ }
    function deactivatePowerUp() { /* ... (å‰å›ã¨åŒæ§˜) ... */ }

    function createItem() {
      if (timeLeft <= 0 || !gameContainer) return;
      const item = document.createElement("div");
      const rand = Math.random();
      let itemTypeForCreation = "normalEgg"; // â˜…â˜…â˜… ã‚¿ã‚¤ãƒ—åå¤‰æ›´ â˜…â˜…â˜…

      // â˜…â˜…â˜… ç¢ºç‡ã¨ã‚¢ã‚¤ãƒ†ãƒ ã‚¿ã‚¤ãƒ—ã®å†å®šç¾© â˜…â˜…â˜…
      let probBomb = 0; if (level >= 2) { probBomb = Math.min(0.05 + (level - 2) * 0.03, 0.14); }
      const probTimePlus = 0.08;
      let probPowerUp = 0; if (level >= 2) { probPowerUp = 0.07; }
      const probHelperMG = 0.06; // MG Chan ã®å‡ºç¾ç¢ºç‡ (6%)
      const probGoldenEgg = 0.10; // é‡‘ã®åµã®ç¢ºç‡ (æ—§golden petal)
      const probSpecialEgg = 0.15; // ç‰¹æ®Šãªåµã®ç¢ºç‡ (æ—§special petal)
      // æ®‹ã‚ŠãŒé€šå¸¸ã®åµ

      let cumulativeProb = 0;
      cumulativeProb += probBomb; if (rand < cumulativeProb && level >= 2) { itemTypeForCreation = "bomb"; }
      else { cumulativeProb += probTimePlus; if (rand < cumulativeProb) { itemTypeForCreation = "timePlus"; }
      else { cumulativeProb += probPowerUp; if (rand < cumulativeProb && level >= 2) { itemTypeForCreation = "powerup"; }
      else { cumulativeProb += probHelperMG; if (rand < cumulativeProb ) { itemTypeForCreation = "helperMG"; } // MG Chan ã¯ãƒ¬ãƒ™ãƒ«1ã‹ã‚‰å‡ºç¾å¯
      else { cumulativeProb += probGoldenEgg; if (rand < cumulativeProb) { itemTypeForCreation = "goldenEgg"; }
      else { cumulativeProb += probSpecialEgg; if (rand < cumulativeProb) { itemTypeForCreation = "specialEgg"; }
      else { itemTypeForCreation = "normalEgg"; }}}}}}}

      let itemWidth;
      switch(itemTypeForCreation) {
        case "bomb": item.className = "bomb"; item.dataset.type = "bomb"; item.dataset.points = "-10"; itemWidth = 40; break;
        case "timePlus": item.className = "time-plus"; item.dataset.type = "timePlus"; itemWidth = 40; break;
        case "powerup": item.className = "power-up"; item.dataset.type = "powerup"; item.dataset.points = "0"; itemWidth = 45; break;
        case "helperMG": item.className = "helper-mgchan"; item.dataset.type = "helperMG"; item.dataset.points = "25"; itemWidth = 60; break; // MG Chan ã¯25ç‚¹
        case "goldenEgg": item.className = "egg golden"; item.dataset.type = "goldenEgg"; item.dataset.points = "5"; itemWidth = 40; break; // CSSã‚¯ãƒ©ã‚¹åã‚‚èª¿æ•´
        case "specialEgg": item.className = "egg special"; item.dataset.type = "specialEgg"; item.dataset.points = "2"; itemWidth = 35; break; // CSSã‚¯ãƒ©ã‚¹åã‚‚èª¿æ•´
        default: /* normalEgg */ item.className = "egg"; item.dataset.type = "normalEgg"; item.dataset.points = "1"; itemWidth = 30;
      }

      item.style.left = Math.random() * (gameContainer.offsetWidth - itemWidth) + "px";
      let animationDuration = Math.max(1.5, (2.5 + Math.random() * 2) - (level * 0.15)); // å°‘ã—è½ä¸‹é€Ÿåº¦èª¿æ•´
      item.style.animationDuration = animationDuration + "s";
      // â˜…â˜…â˜… è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¢ã‚¤ãƒ†ãƒ ã‚¿ã‚¤ãƒ—ã”ã¨ã«è¨­å®š â˜…â˜…â˜…
      if (itemTypeForCreation === "normalEgg") item.style.animationName = "fall-egg";
      else if (itemTypeForCreation === "specialEgg") item.style.animationName = "fall-special-egg";
      else if (itemTypeForCreation === "goldenEgg") item.style.animationName = "fall-golden-egg";
      else if (itemTypeForCreation === "helperMG") item.style.animationName = "fall-helper";
      // bomb, powerup, timePlus ã¯æ—¢å­˜ã® fall-bomb ãªã©ã‚’ä½¿ç”¨

      gameContainer.appendChild(item);

      const checkCollision = setInterval(() => {
        if (!item.parentNode || timeLeft <= 0) { clearInterval(checkCollision); if(item.parentNode) item.remove(); return; }
        const rect1 = item.getBoundingClientRect(); const rect2 = character.getBoundingClientRect();
        if ( rect1.top < rect2.bottom && rect1.bottom > rect2.top && rect1.left < rect2.right && rect1.right > rect2.left ) {
          const currentItemType = item.dataset.type;
          const points = parseInt(item.dataset.points) || 0;

          if (currentItemType === "bomb") {
            score = Math.max(0, score + points); scoreDisplay.innerText = score; resetCombo();
            if (seBomb && typeof seBomb.play === 'function') { seBomb.currentTime = 0; seBomb.play().catch(err => console.warn("bom.mp3 å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));}
            gameContainer.style.background = 'rgba(150,50,50,0.7)'; setTimeout(() => { gameContainer.style.background = 'linear-gradient(135deg, #fffacd 0%, #f5deb3 50%, #ffe4b5 100%)'; }, 150);
          } else if (currentItemType === "timePlus") {
            timeLeft = Math.min(timeLeft + 5, MAX_TIME_LEFT); timerDisplay.innerText = timeLeft;
            if (seTimePlus && typeof seTimePlus.play === 'function') { seTimePlus.currentTime = 0; seTimePlus.play().catch(err => console.warn("tm.mp3 å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));}
          } else if (currentItemType === "powerup") {
            if (sePowerUp && typeof sePowerUp.play === 'function') { sePowerUp.currentTime = 0; sePowerUp.play().catch(err => console.warn("st.mp3 å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));}
            activatePowerUp();
          } else if (currentItemType === "helperMG") {
            updateScore(points); // MG Chanå–å¾—ã§25ç‚¹
            if (seHelperMG && typeof seHelperMG.play === 'function') { seHelperMG.currentTime = 0; seHelperMG.play().catch(err => console.warn("MG Chan SE å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));}
            // MG Chan ã®åŠ¹æœ: ä¾‹ã¨ã—ã¦ã€ä¸€æ™‚çš„ã«ã‚¢ã‚¤ãƒ†ãƒ è½ä¸‹é€Ÿåº¦ã‚’é…ãã™ã‚‹ã€ã¾ãŸã¯é«˜å¾—ç‚¹ã‚¢ã‚¤ãƒ†ãƒ ã®å‡ºç¾ç‡ã‚’ä¸Šã’ã‚‹ãªã©
            // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œç”»é¢ä¸Šã®çˆ†å¼¾ã‚’ã„ãã¤ã‹æ¶ˆã™ã€åŠ¹æœã«ã—ã¦ã¿ã¾ã™
            const bombsOnScreen = gameContainer.querySelectorAll('.bomb');
            bombsOnScreen.forEach((bomb, index) => {
                if (index < 2 && bomb.parentNode) { // æœ€å¤§2ã¤ã¾ã§
                    bomb.remove(); // è¡çªåˆ¤å®šä¸­ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã¯ã‚¯ãƒªã‚¢ã•ã‚Œãªã„ãŒã€DOMã‹ã‚‰æ¶ˆãˆã‚‹
                }
            });
            // TODO: çˆ†å¼¾ã‚’æ¶ˆã—ãŸå ´åˆã€ãã®çˆ†å¼¾ã®checkCollisionã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚‚ã‚¯ãƒªã‚¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€ã“ã“ã§ã¯çœç•¥
          } else { // normalEgg, specialEgg, goldenEgg
            updateScore(points);
            if (seEggCollect && typeof seEggCollect.play === 'function') {
                seEggCollect.currentTime = 0;
                seEggCollect.play().catch(err => console.warn("åµå–å¾—éŸ³ å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
            }
          }
          item.remove(); clearInterval(checkCollision);
        }
      }, 30);
      setTimeout(() => { if (item.parentNode) { item.remove(); if (item.dataset.type.includes("Egg")) { resetCombo(); } } clearInterval(checkCollision); }, animationDuration * 1000 + 300);
    }

    let gameTimerId = null;
    function startGame() {
      characterX = gameContainer.offsetWidth / 2; updateCharacterPosition();
      if (bgm && typeof bgm.play === 'function' && bgm.paused) { bgm.play().catch(err => console.warn("BGMå†ç”Ÿã«å¤±æ•—:", err)); }
      itemSpawnerId = setInterval(createItem, getSpawnRate());
      gameBgParticleInterval = setInterval(createBackgroundParticle, 700); // ã‚²ãƒ¼ãƒ å†…ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«é »åº¦èª¿æ•´
      outerEffectInterval = setInterval(createOuterEffectParticle, 500); // å¤–å´ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé »åº¦èª¿æ•´

      gameTimerId = setInterval(() => {
        if (timeLeft <= 0) {
            clearInterval(gameTimerId); clearInterval(itemSpawnerId);
            clearInterval(gameBgParticleInterval); clearInterval(outerEffectInterval);
            if (powerUpTimerId) clearInterval(powerUpTimerId); endGame(); return;
        }
        timeLeft--; timerDisplay.innerText = timeLeft;
        if(timeLeft > 0) { clearInterval(itemSpawnerId); itemSpawnerId = setInterval(createItem, getSpawnRate()); }
      }, 1000);
    }

    function endGame() { /* ... (å‰å›ã¨åŒæ§˜ã€ãŸã ã—localStorageã‚­ãƒ¼åã¯é©å®œå¤‰æ›´) ... */
      if (bgm && typeof bgm.pause === 'function') bgm.pause();
      finalScore.innerText = score; finalLevel.innerText = level; gameover.style.display = "block";
      if (score > highscore) { highscore = score; try { localStorage.setItem("eggCatchGameHighscore", highscore); highscoreDisplay.innerText = highscore; } catch (error) { } }
      Array.from(gameContainer.children).forEach(child => {
        if (child.id !== 'character' && child.id !== 'gameover' && !child.classList.contains('combo-display') && !child.classList.contains('level-up-effect') && !child.classList.contains('power-effect') ) {
            if (child.classList.contains('egg') || child.classList.contains('bomb') || child.classList.contains('power-up') || child.classList.contains('time-plus') || child.classList.contains('helper-mgchan') || child.classList.contains('bg-particle')) {
                child.remove();
            }
        }
      });
      if(pageWrapper) pageWrapper.querySelectorAll('.outer-sakura-particle').forEach(el => el.remove()); // outer-effect-particle ã«ã‚¯ãƒ©ã‚¹åå¤‰æ›´ã—ãŸå ´åˆã¯ãã¡ã‚‰ã‚‚
      if (returnToSelectBtn) { returnToSelectBtn.addEventListener("click", () => { window.location.href = "index.html"; }); }
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã€ã‚¹ãƒ¯ã‚¤ãƒ—æ“ä½œã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å‰å›ã‹ã‚‰å¤‰æ›´ãªã—
    // ãŸã ã—ã€characterX ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯ã¯ gameContainer.offsetWidth ã‚’ä½¿ã†
    document.addEventListener("keydown", (e) => { if (timeLeft <= 0) return; let moved = false; const charWidth = character.offsetWidth || 120; if (e.key === "ArrowLeft") { characterX -= 30; moved = true; } else if (e.key === "ArrowRight") { characterX += 30; moved = true; } else if (e.key === " " || e.key === "ArrowUp") { e.preventDefault(); jump(); } if (moved) { characterX = Math.max(charWidth / 2, Math.min(gameContainer.offsetWidth - (charWidth / 2), characterX)); updateCharacterPosition(); } });
    function jump() { if (!character.classList.contains("jump") && timeLeft > 0) { character.classList.add("jump"); setTimeout(() => character.classList.remove("jump"), 600); } }
    character.addEventListener("click", (e) => { if (timeLeft <= 0) return; e.preventDefault(); jump(); }, { passive: false });
    const leftBtn = document.createElement("button"); leftBtn.innerText = "â—€"; leftBtn.className = "control-btn"; leftBtn.style.left = "20px";
    const rightBtn = document.createElement("button"); rightBtn.innerText = "â–¶"; rightBtn.className = "control-btn"; rightBtn.style.right = "20px";
    pageWrapper.appendChild(leftBtn); pageWrapper.appendChild(rightBtn);
    let moveInterval = null;
    function startMove(direction) { if (moveInterval || timeLeft <= 0) return; const charWidth = character.offsetWidth || 120; moveInterval = setInterval(() => { if (direction === "left") characterX -= 15; else if (direction === "right") characterX += 15; characterX = Math.max(charWidth / 2, Math.min(gameContainer.offsetWidth - (charWidth / 2), characterX)); updateCharacterPosition(); }, 30); }
    function stopMove() { clearInterval(moveInterval); moveInterval = null; }
    leftBtn.addEventListener("touchstart", (e) => { e.preventDefault(); startMove("left"); }, { passive: false });
    rightBtn.addEventListener("touchstart", (e) => { e.preventDefault(); startMove("right"); }, { passive: false });
    document.addEventListener("touchend", (e) => { if (moveInterval) stopMove(); }, { passive: false });
    leftBtn.addEventListener("mousedown", () => startMove("left"));
    rightBtn.addEventListener("mousedown", () => startMove("right"));
    document.addEventListener("mouseup", stopMove);
    let touchStartX = null; let touchStartY = null; const swipeThreshold = 30;
    function getTouchXInGameContainer(clientX) { const gameContainerRect = gameContainer.getBoundingClientRect(); return clientX - gameContainerRect.left; }
    gameContainer.addEventListener("touchstart", (e) => { if (timeLeft <= 0 || e.target.classList.contains('control-btn')) return; const touch = e.changedTouches[0]; const gameContainerRect = gameContainer.getBoundingClientRect(); if (touch.clientX >= gameContainerRect.left && touch.clientX <= gameContainerRect.right && touch.clientY >= gameContainerRect.top && touch.clientY <= gameContainerRect.bottom) { touchStartX = getTouchXInGameContainer(touch.clientX); touchStartY = touch.clientY; } else { touchStartX = null; touchStartY = null; } }, { passive: true });
    gameContainer.addEventListener("touchmove", (e) => { if (timeLeft <= 0 || touchStartX === null || e.target.classList.contains('control-btn')) return; let currentRelativeX = getTouchXInGameContainer(e.changedTouches[0].clientX); let deltaX = currentRelativeX - touchStartX; characterX += deltaX; const charWidth = character.offsetWidth || 120; characterX = Math.max(charWidth / 2, Math.min(gameContainer.offsetWidth - (charWidth / 2), characterX)); updateCharacterPosition(); touchStartX = currentRelativeX; }, { passive: true });
    gameContainer.addEventListener("touchend", (e) => { if (timeLeft <= 0 || touchStartX === null || touchStartY === null || e.target.classList.contains('control-btn')) { touchStartX = null; touchStartY = null; return; } const finalTouchX = getTouchXInGameContainer(e.changedTouches[0].clientX); const deltaX = finalTouchX - touchStartX; const deltaY = e.changedTouches[0].clientY - touchStartY; if (Math.abs(deltaY) > Math.abs(deltaX) && deltaY < -swipeThreshold) jump(); touchStartX = null; touchStartY = null; }, { passive: true });
    window.addEventListener('resize', () => { const charWidth = character.offsetWidth || 120; characterX = Math.max(charWidth / 2, Math.min(gameContainer.offsetWidth - (charWidth / 2), characterX)); updateCharacterPosition(); });
    function attemptBgmPlay() { if (bgm && typeof bgm.play === 'function' && bgm.paused) { bgm.play().then(() => { document.body.removeEventListener('click', attemptBgmPlay); document.body.removeEventListener('touchstart', attemptBgmPlay); }).catch(error => { console.warn("BGMã®å†ç”Ÿè©¦è¡Œã«å¤±æ•—ã—ã¾ã—ãŸ:", error); }); } else if (bgm && !bgm.paused) { document.body.removeEventListener('click', attemptBgmPlay); document.body.removeEventListener('touchstart', attemptBgmPlay); } }
    document.body.addEventListener('click', attemptBgmPlay, {once: true});
    document.body.addEventListener('touchstart', attemptBgmPlay, {once: true});
    startGame();
  </script>
</body>
</html>
