<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CNP-CATCH</title>
  <style>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        å…±é€šãƒªã‚»ãƒƒãƒˆ & ãƒ•ã‚©ãƒ³ãƒˆ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
    body{
      width:100vw;height:100vh;overflow:hidden;
      font-family:'Noto Sans JP',sans-serif;
      touch-action:manipulation;-webkit-overflow-scrolling:touch;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #page-wrapper{
      width:100%;height:100%;
      background:#000;
      display:flex;justify-content:center;align-items:center;
      position:relative;overflow:hidden;
    }
    #game-container{
      position:relative;width:100%;max-width:380px;height:100%;
      background:#000;
      overflow:hidden;
      transition: box-shadow 0.3s ease-in-out; /* â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : transition for fever glow */
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .bg-bubble-particle{position:absolute;border-radius:50%;pointer-events:none;animation:float-bubble linear infinite;z-index:1;opacity:0}
    .bg-bubble-particle.yellow{background:rgba(255,215,0,.15)}
    .bg-bubble-particle.white{background:rgba(255,250,240,.12)}
    @keyframes float-bubble{
      0%{transform:translateY(105%) scale(var(--bubble-scale));opacity:0}
      20%,80%{opacity:var(--bubble-opacity)}
      100%{transform:translateY(-10%) scale(var(--bubble-scale));opacity:0}
    }
    .outer-shell-particle{
      position:absolute;pointer-events:none;opacity:0;z-index:5;
      background:rgba(245,222,179,.3);
      width:var(--shell-width);height:var(--shell-height);
      border-radius:30% 70% 20% 80%/50% 40% 60% 50%;
      animation:fall-outer-shell linear infinite;
    }
    @keyframes fall-outer-shell{
      0%{transform:translateY(-10vh) translateX(var(--outer-start-x)) rotateZ(0) rotateY(var(--outer-rotate-y-start));opacity:0}
      10%,90%{opacity:.5}
      100%{transform:translateY(110vh) translateX(var(--outer-end-x)) rotateZ(var(--outer-rotate-z-end)) rotateY(var(--outer-rotate-y-end));opacity:0}
    }

    @keyframes game-twinkle {
      0%, 100% { transform: scale(.3); opacity: 0; }
      10%      { opacity: .6; }
      50%      { opacity: .8; transform: scale(.5); }
      90%      { opacity: .6; }
    }
    .game-bg-star {
      position: absolute;
      width: 2px;
      height: 2px;
      border-radius: 50%;
      background: #fff;
      pointer-events: none;
      animation: game-twinkle 4s linear infinite;
      filter: drop-shadow(0 0 2px #fff) drop-shadow(0 0 4px #fff);
      z-index: 0;
    }


    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #character{
      position:absolute;bottom:80px;left:50%;
      transform:translateX(-50%) scale(1);
      max-height:20vh;max-width:100px;height:auto;z-index:50;
      filter:drop-shadow(2px 4px 8px rgba(0,0,0,.2));
      transition: transform 0.2s ease-out, filter 0.2s ease-out;
    }
    #character.jump{ /* jump-anim ã«ã‚¯ãƒ©ã‚¹åå¤‰æ›´ */
        animation:jump-anim .6s ease;
    }
    #character.powerup{
      filter:drop-shadow(0 0 15px #FFD700) drop-shadow(2px 4px 8px rgba(0,0,0,.2));
      transform:translateX(-50%) scale(1.5);
    }
    /* â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
    #character.fever-character {
      /* ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã¨ä½µç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ã‚’è€ƒæ…® */
      /* animation: character-fever-aura 0.3s infinite alternate; */ /* ä¸‹è¨˜ã«çµ±åˆ */
    }
    /* â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã¨ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãŒåŒæ™‚ */
    #character.powerup.fever-character {
      transform: translateX(-50%) scale(1.65); /* å°‘ã—ã ã‘å¤§ãã */
      animation: character-fever-powerup-aura 0.25s infinite alternate;
    }
    @keyframes character-fever-powerup-aura { /* ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ï¼‹ãƒ•ã‚£ãƒ¼ãƒãƒ¼æ™‚ã®ã‚ªãƒ¼ãƒ© */
        0% { filter: drop-shadow(0 0 15px red) drop-shadow(0 0 20px orange) drop-shadow(0 0 25px yellow) drop-shadow(2px 4px 8px rgba(0,0,0,.2)); }
        50% { filter: drop-shadow(0 0 25px yellow) drop-shadow(0 0 30px gold) drop-shadow(0 0 35px orangered) drop-shadow(2px 4px 8px rgba(0,0,0,.2)); }
        100% { filter: drop-shadow(0 0 15px orangered) drop-shadow(0 0 20px yellow) drop-shadow(0 0 25px gold) drop-shadow(2px 4px 8px rgba(0,0,0,.2)); }
    }
     /* â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã®ã¿ã®å ´åˆã®ã‚ªãƒ¼ãƒ© (ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å‚è€ƒã«èª¿æ•´) */
    #character.fever-character:not(.powerup) {
        animation: character-fever-only-aura 0.3s infinite alternate;
    }
    @keyframes character-fever-only-aura {
        0% { filter: drop-shadow(0 0 15px #ff00ff) drop-shadow(0 0 20px #ff00ff) drop-shadow(2px 4px 8px rgba(0,0,0,.2)); }
        100% { filter: drop-shadow(0 0 20px #ff00ff) drop-shadow(0 0 25px #ee82ee) drop-shadow(2px 4px 8px rgba(0,0,0,.2)); }
    }

    @keyframes jump-anim{ /* jumpã‹ã‚‰jump-animã«åå‰å¤‰æ›´ */
      0% { transform: translateX(-50%) translateY(0) scale(var(--current-scale, 1)); }
      30%, 60% { transform: translateX(-50%) translateY(-60px) scale(var(--current-scale, 1)); }
      100% { transform: translateX(-50%) translateY(0) scale(var(--current-scale, 1)); }
    }
    #character.electrocuted {
      animation: electric-shock 0.08s infinite;
    }
    @keyframes electric-shock {
      0% { transform: translateX(-51%) rotate(-2deg) scale(var(--current-scale, 1)); }
      25% { transform: translateX(-49%) rotate(2deg) scale(var(--current-scale, 1)); }
      50% { transform: translateX(-51%) rotate(-1deg) scale(var(--current-scale, 1)); }
      75% { transform: translateX(-49%) rotate(1deg) scale(var(--current-scale, 1)); }
      100% { transform: translateX(-50%) rotate(0deg) scale(var(--current-scale, 1)); }
    }


    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ã‚¢ã‚¤ãƒ†ãƒ 
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¿®æ­£: .makimono ã‚‚å¯¾è±¡ã«è¿½åŠ  */
    .egg,.bomb,.power-up,.time-plus,.helper-mgchan,.helper-ikehaya,.helper-road, .lightning, .makimono {
      position:absolute;pointer-events:none;z-index:40;
      background-position:center;background-repeat:no-repeat;background-size:contain;
    }

    .egg{
      --start-rot-z: 0deg;
      --end-rot-z  : 0deg;
      background-color: #fff;
      width:30px;
      height:30px;
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      animation-name:fall-egg;animation-timing-function:linear;
      filter:drop-shadow(0 2px 2px rgba(0,0,0,.15));
    }
    .egg.special{
      background-color: #87CEEB;
      width:38px;
      height:38px;
      animation-name:fall-special-egg;animation-timing-function:linear;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,.2));
    }
    .egg.golden{
      background-color: #FFD700;
      width:46px;
      height:46px;
      animation-name:fall-golden-egg;animation-timing-function:linear;
      filter:drop-shadow(0 0 15px gold) drop-shadow(0 0 5px white);
    }
    /* â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : å·»ç‰©ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .makimono {
      width: 55px;
      height: 55px;
      background-image: url("makimono.webp"); /* ç”»åƒãƒ‘ã‚¹æ³¨æ„ */
      animation-name: fall-powerup; /* æ—¢å­˜ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æµç”¨ or å°‚ç”¨ä½œæˆ */
      filter: drop-shadow(0 0 10px #ffd700) drop-shadow(0 0 15px #ff8c00) drop-shadow(0 0 5px #ffffff);
      z-index: 45; /* ä»–ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚ˆã‚Šå°‘ã—æ‰‹å‰ãªã© */
    }
    /* â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’å…‰ã‚‰ã›ã‚‹ã‚¯ãƒ©ã‚¹ */
    .fever-item-glow {
      filter: drop-shadow(0 0 8px #FFD700) drop-shadow(0 0 15px #FFA500) drop-shadow(0 0 5px #ffffff) !important;
      transform: scale(1.1); /* å°‘ã—å¤§ãã */
    }


    .helper-mgchan{
      width:60px;height:60px;
      background-image:url("MG Chan.PNG");
      animation-name:fall-helper;animation-timing-function:linear;
      border-radius:15px;
      filter:drop-shadow(0 3px 5px rgba(0,0,0,.3));
    }
    .helper-ikehaya, .helper-road {
      width:60px;
      height:60px;
      animation-name:fall-helper;
      animation-timing-function:linear;
      border-radius:15px;
      filter:drop-shadow(0 3px 5px rgba(0,0,0,.3));
    }
    .helper-ikehaya {
      background-image:url("ikehaya.webp");
    }
    .helper-road {
      background-image:url("Road.webp");
    }

    .bomb{
      width:40px;height:40px;
      background:radial-gradient(circle,#5a3d32 0%,#3e2723 70%,#2d1b17 100%);
      border-radius:50%;
      filter:drop-shadow(0 0 10px rgba(40,20,10,.8));
      animation-name:fall-bomb;animation-timing-function:linear;
    }
    .bomb::before{
      content:'ğŸ’£';position:absolute;top:50%;left:50%;
      transform:translate(-50%,-50%);
      font-size:28px;color:#FF4500;text-shadow:0 0 5px #FF0000;
      animation:bomb-pulse .5s infinite alternate;
    }
    .power-up{
      width:45px;height:45px;border-radius:50%;
      background:linear-gradient(45deg,#FFD700,#FFA500,#FF8C00,#FF7F50,#FF6347);
      filter:drop-shadow(0 0 15px rgba(255,165,0,.8));
      animation:fall-powerup linear 1,var(--dummy,1s) ease infinite;
    }
    .power-up::before{
      content:'ğŸŒŸ';position:absolute;top:50%;left:50%;
      transform:translate(-50%,-50%);font-size:25px;
      animation:star-spin 1.5s linear infinite;
    }
    .time-plus{
      width:40px;height:40px;border-radius:50%;
      background:radial-gradient(circle,#F0E68C 0%,#EEE8AA 50%,#BDB76B 100%);
      filter:drop-shadow(0 0 8px rgba(218,165,32,.7));
      animation:fall-time-plus linear;
    }
    .time-plus::before{
      content:'â±ï¸';position:absolute;top:50%;left:50%;
      transform:translate(-50%,-50%);font-size:25px;
      animation:time-pulse 1.5s ease-in-out infinite alternate;
    }
    .lightning {
      width: 45px;
      height: 45px;
      font-size: 38px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #FFFF00;
      text-shadow: 0 0 5px #FFD700, 0 0 10px #FFEA00;
      animation-name: fall-bomb; 
      animation-timing-function: linear;
      filter: drop-shadow(0 0 8px gold);
    }
    .lightning::before {
      content: 'âš¡ï¸';
    }

    /* UI CSS */
    #scoreboard,#level-display,.control-btn,.power-effect,.combo-display,.level-up-effect{position:fixed;z-index:200}
    #scoreboard{top:15px;right:20px;font-size:14px;font-weight:bold;color:#604020;background:linear-gradient(145deg,#fff8dc 0%,#ffefd5 100%);padding:15px 20px;border-radius:20px;line-height:1.6;box-shadow:0 8px 24px rgba(0,0,0,.1),0 4px 8px rgba(139,69,19,.2);border:2px solid rgba(210,180,140,.5);backdrop-filter:blur(10px);min-width:180px;}
    #level-display{top:15px;left:20px;font-size:16px;font-weight:bold;color:#604020;background:linear-gradient(145deg,#fff8dc 0%,#ffefd5 100%);padding:12px 18px;border-radius:15px;box-shadow:0 4px 12px rgba(0,0,0,.1),0 2px 4px rgba(139,69,19,.2);border:2px solid rgba(210,180,140,.5);backdrop-filter:blur(5px);}
    .combo-display{top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;font-weight:bold;color:#FF8C00;background:rgba(60,30,10,.85);padding:10px 20px;border-radius:15px;display:none;animation:combo-pop 1s ease-out;text-shadow:1px 1px 2px rgba(255,255,255,.3);z-index:210;}
    #gameover{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:28px;font-weight:bold;background:linear-gradient(145deg,rgba(80,50,20,.9),rgba(50,30,10,.85));color:#fff8dc;padding:30px;border-radius:20px;display:none;z-index:150;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.5);border:2px solid rgba(210,180,140,.3);width:90%;max-width:380px;}
    #return-to-select-btn{background:#D2691E;color:#fff;border:none;padding:12px 25px;margin-top:25px;font-size:16px;border-radius:8px;cursor:pointer;transition:.3s;}
    #return-to-select-btn:hover{background:#A0522D}
    .control-btn{bottom:15px;width:55px;height:55px;font-size:22px;border-radius:50%;border:none;background:linear-gradient(145deg,rgba(210,180,140,.9) 0%,rgba(139,69,19,.8) 100%);color:#fff;cursor:pointer;box-shadow:0 6px 18px rgba(139,69,19,.4),0 3px 6px rgba(0,0,0,.2);border:2px solid rgba(255,255,255,.4);transition:.2s;}
    .control-btn:active{transform:scale(.95);box-shadow:0 3px 9px rgba(139,69,19,.4),0 1px 3px rgba(0,0,0,.2)}
    .power-effect{bottom:150px;left:20px;padding:8px 16px;font-size:14px;font-weight:bold;background:linear-gradient(45deg,#FFA500,#FF4500);color:#fff;border-radius:20px;display:none;animation:power-glow .5s ease-in-out infinite alternate;}
    .level-up-effect{top:30%;left:50%;transform:translate(-50%,-50%);font-size:32px;font-weight:bold;color:#CD853F;background:linear-gradient(45deg,rgba(255,228,181,.9),rgba(255,218,185,.8));padding:20px 40px;border-radius:20px;display:none;animation:level-up-animation 2s ease-out;text-shadow:1px 1px 2px rgba(100,50,0,.5);border:3px solid rgba(255,255,255,.8);z-index:210;}

    /* â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠã®å…‰å½© */
    #game-container.fever-active {
      animation: fever-glow-animation 0.4s infinite alternate;
    }
    @keyframes fever-glow-animation {
      from { box-shadow: 0 0 25px #FFD700, 0 0 35px #FF8C00 inset, 0 0 30px #FFFACD; }
      to   { box-shadow: 0 0 40px #FFA500, 0 0 50px #FF4500 inset, 0 0 45px #FFD700; }
    }
    /* â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¿ã‚¤ãƒ è¡¨ç¤º */
    #fever-mode-display {
      position: fixed; /* game-containerã§ã¯ãªãviewportåŸºæº– */
      top: 35%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 38px; font-weight: bold;
      color: #fff;
      background: linear-gradient(45deg, #ff1493, #ff69b4, #ff7f50, #ffa500, #ffd700);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      padding: 15px 30px; border-radius: 20px;
      text-shadow: 0 0 5px rgba(255,255,255,0.8), 0 0 10px #ff8c00, 0 0 15px #ff4500;
      border: 3px solid;
      border-image-slice: 1;
      border-image-source: linear-gradient(to right, gold, orangered);
      box-shadow: 0 0 20px rgba(255,100,0,0.7);
      display: none; /* JSã§åˆ¶å¾¡ */
      z-index: 220;
      animation: fever-text-pop-anim 2.5s ease-out forwards;
    }
    @keyframes fever-text-pop-anim {
      0% { transform: translate(-50%, -50%) scale(0.3) rotate(-15deg); opacity: 0; }
      20% { transform: translate(-50%, -50%) scale(1.2) rotate(5deg); opacity: 1; }
      80% { transform: translate(-50%, -50%) scale(1.1) rotate(0deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1.1) rotate(0deg); opacity: 0; }
    }
     /* â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã®æ˜Ÿã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¤‰æ›´ */
    #game-container.fever-active .game-bg-star {
        animation-duration: 0.8s !important; /* ç‚¹æ»…ã‚’é€Ÿã */
        filter: drop-shadow(0 0 4px #FFD700) drop-shadow(0 0 8px #FFD700) drop-shadow(0 0 2px #FFFFFF);
        background: #FFFACD; /* æ˜Ÿã®è‰²ã‚’é‡‘è‰²ã£ã½ã */
        transform: scale(var(--fever-star-scale, 0.7)); /* æ˜Ÿã‚’å°‘ã—å¤§ãã */
    }


    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
    @keyframes bomb-pulse{0%{transform:translate(-50%,-50%) scale(1)}100%{transform:translate(-50%,-50%) scale(1.2)}}
    @keyframes star-spin{0%{transform:translate(-50%,-50%) rotate(0) scale(1)}50%{transform:translate(-50%,-50%) rotate(180deg) scale(1.2)}100%{transform:translate(-50%,-50%) rotate(360deg) scale(1)}}
    @keyframes rainbow-rotate-warm{0%{filter:drop-shadow(0 0 15px rgba(255,165,0,.8)) hue-rotate(0)}100%{filter:drop-shadow(0 0 15px rgba(255,165,0,.8)) hue-rotate(45deg)}}
    @keyframes power-glow{0%{box-shadow:0 0 10px rgba(255,165,0,.8)}100%{box-shadow:0 0 20px rgba(255,120,0,1)}}
    @keyframes level-up-animation{0%{transform:translate(-50%,-50%) scale(.5) rotate(-10deg);opacity:0}30%{transform:translate(-50%,-50%) scale(1.2) rotate(5deg);opacity:1}70%{transform:translate(-50%,-50%) scale(1.1) rotate(-2deg);opacity:1}100%{transform:translate(-50%,-50%) scale(1) rotate(0);opacity:0}}
    @keyframes time-pulse{0%{transform:translate(-50%,-50%) scale(1) rotate(0);opacity:.8}50%{transform:translate(-50%,-50%) scale(1.15) rotate(5deg);opacity:1}100%{transform:translate(-50%,-50%) scale(1) rotate(0);opacity:.8}}
    @keyframes fall-egg{0%{transform:translateY(-70px) rotateZ(var(--start-rot-z)) scale(.8);opacity:.6}100%{transform:translateY(105vh) rotateZ(var(--end-rot-z));opacity:1}}
    @keyframes fall-special-egg{0%{transform:translateY(-60px) rotateZ(0) scale(.9);opacity:.8}50%{transform:translateY(50vh) rotateZ(90deg) scale(1.1)}100%{transform:translateY(105vh) rotateZ(180deg) scale(.9);opacity:1}}
    @keyframes fall-golden-egg{0%{transform:translateY(-60px) rotateZ(0) scale(1);opacity:.9}25%{transform:translateY(25vh) rotateZ(var(--random-rotate-half)) scale(1.15)}100%{transform:translateY(105vh) rotateZ(var(--random-rotate)) scale(1);opacity:1}}
    @keyframes fall-helper{0%{transform:translateY(-80px) scale(.7) rotate(-15deg);opacity:.7}50%{transform:translateY(40vh) scale(1) rotate(15deg);opacity:1}100%{transform:translateY(105vh) scale(.8) rotate(5deg);opacity:.9}}
    @keyframes fall-bomb{0%{transform:translateY(-50px) rotate(0) scale(1);opacity:1}30%{transform:translateY(30vh) rotate(-20deg) scale(1.05)}60%{transform:translateY(60vh) rotate(15deg) scale(1.1)}100%{transform:translateY(100vh) rotate(10deg) scale(1);opacity:1}}
    @keyframes fall-powerup{0%{transform:translateY(-50px) scale(.8);opacity:.8}25%{transform:translateY(25vh) scale(1.1);opacity:1}50%{transform:translateY(50vh) scale(1.2)}75%{transform:translateY(75vh) scale(1.1)}100%{transform:translateY(100vh) scale(1);opacity:1}}
    @keyframes fall-time-plus{0%{transform:translateY(-50px) translateX(0) rotate(0) scale(.9);opacity:.7}25%{transform:translateY(25vh) translateX(10px) rotate(5deg) scale(1);opacity:1}50%{transform:translateY(50vh) translateX(-10px) rotate(-5deg) scale(1.1)}75%{transform:translateY(75vh) translateX(5px) rotate(2deg) scale(1)}100%{transform:translateY(100vh) translateX(0) rotate(0) scale(.9);opacity:1}}

  </style>
</head>
<body>
  <div id="page-wrapper">
    <div id="game-container">
      <img id="character" src="" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼">
      <div id="gameover">
        <div>ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</div>
        <div style="font-size:18px;margin-top:10px">
          æœ€çµ‚ã‚¹ã‚³ã‚¢:<span id="final-score">0</span><br>
          åˆ°é”ãƒ¬ãƒ™ãƒ«:<span id="final-level">1</span>
        </div>
        <button id="return-to-select-btn">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã«æˆ»ã‚‹</button>
      </div>
      <div class="combo-display" id="combo-display-popup"></div>
      <div class="level-up-effect" id="level-up-effect"></div>
      <div class="power-effect"  id="power-effect"></div>
      <div id="fever-mode-display">FEVER TIME!</div>
    </div>
  </div>

  <div id="scoreboard">ã‚¹ã‚³ã‚¢:<span id="score">0</span><br>ãƒã‚¤ã‚¹ã‚³ã‚¢:<span id="highscore">0</span><br>æ®‹ã‚Š:<span id="timer">60</span>ç§’<br>ã‚³ãƒ³ãƒœ:<span id="combo">0</span></div>
  <div id="level-display">ãƒ¬ãƒ™ãƒ«:<span id="level">1</span></div>

  <script>
    document.addEventListener('contextmenu',e=>{e.preventDefault()},{passive:false});
    document.addEventListener('selectstart',e=>{e.preventDefault()},{passive:false});
    document.addEventListener('dragstart',e=>{e.preventDefault()},{passive:false});

    const pageWrapper          = document.getElementById("page-wrapper");
    const gameContainer        = document.getElementById("game-container");
    const character            = document.getElementById("character");
    const scoreDisplay         = document.getElementById("score");
    const highscoreDisplay     = document.getElementById("highscore");
    const timerDisplay         = document.getElementById("timer");
    const levelDisplay         = document.getElementById("level");
    const comboCountDisplay    = document.getElementById("combo");
    const comboPopup           = document.getElementById("combo-display-popup");
    const powerEffect          = document.getElementById("power-effect");
    const levelUpEffect        = document.getElementById("level-up-effect");
    const gameover             = document.getElementById("gameover");
    const finalScore           = document.getElementById("final-score");
    const finalLevel           = document.getElementById("final-level");
    const returnToSelectBtn    = document.getElementById("return-to-select-btn");
    const feverModeDisplay     = document.getElementById("fever-mode-display"); // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ 

    const selectedImageFile = localStorage.getItem("selectedImage");
    const selectedCharName  = localStorage.getItem("selectedName");
    if(selectedImageFile && selectedCharName){
      character.src = selectedImageFile;
      character.alt = selectedCharName;
    }else{
      character.src = "Leeleeg.webp"; 
      character.alt = "Leelee";    
    }
    // å…ƒã®ã‚³ãƒ¼ãƒ‰ã®è©²å½“éƒ¨åˆ†ã‚’æ¢ã—ã¦ã€ä»¥ä¸‹ã®å†…å®¹ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

let score=0,highscore=0,timeLeft=60;
// â˜…â˜…â˜…â˜…â˜… ãƒ¬ãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ å¤‰æ›´ç®‡æ‰€ â˜…â˜…â˜…â˜…â˜…
const MAX_TIME_LEFT=90, MAX_LEVEL=15; // æœ€å¤§ãƒ¬ãƒ™ãƒ«ã‚’15ã«å¤‰æ›´
let level=1,combo=0,maxCombo=0;
const levelThresholds=[ // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã«å¿…è¦ãªã‚¹ã‚³ã‚¢ã‚’ãƒ¬ãƒ™ãƒ«15ã¾ã§å®šç¾©
    0,   30,  80, 150,  250,  // Level 1-5 (æ—¢å­˜ã®ã¾ã¾)
  350, 450, 550, 650,  750,  // Level 6-10 (250ã‹ã‚‰+100ãšã¤)
  850, 950,1050,1150, 1250   // Level 11-15 (+100ãšã¤)
]; 
// â˜…â˜…â˜…â˜…â˜… ãƒ¬ãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ å¤‰æ›´ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…â˜…â˜…
let itemSpawnerId,gameBgParticleInterval,outerEffectInterval, gameTimerId;
let isPowerUpActive=false,powerUpEndTime=0;
let characterX,powerUpTimerId=null;
let lastHelperIndex = -1;
let isCharacterStunned = false; 
let stunTimeoutId = null;


      

    // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ãƒ•ã‚£ãƒ¼ãƒãƒ¼é–¢é€£å¤‰æ•°
    let isFeverModeActive = false;
    let feverModeEndTime = 0;
    let feverModeTimerId = null;
    let originalBGMVolume = 0.5; // BGMã®å…ƒã®éŸ³é‡ã‚’ä¿å­˜
    let feverBGM;
    let seFeverStart; // ãƒ•ã‚£ãƒ¼ãƒãƒ¼é–‹å§‹åŠ¹æœéŸ³ (ä»»æ„)
    let feverSpawnedLevel2 = false;
    let feverSpawnedLevel5 = false;
    const FEVER_DURATION = 8000; // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰æŒç¶šæ™‚é–“ (ãƒŸãƒªç§’)
    let characterSpeedMultiplier = 1; // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç§»å‹•é€Ÿåº¦ã®å€ç‡

    let seEggCollect,bgm,seTimePlus,seBomb,sePowerUp,seHelperMG, seHelperIkehaya, seHelperRoad, seLightning, seMakimonoGet;
    try{
      seEggCollect=new Audio("kirarin.mp3");
      bgm           =new Audio("main2.mp3");
      seTimePlus  =new Audio("tm.mp3");
      seBomb      =new Audio("bom.mp3");
      sePowerUp   =new Audio("st.mp3");
      seHelperMG  =new Audio("mg_chan_effect.mp3"); 
      seHelperIkehaya = new Audio("mg_chan_effect.mp3"); 
      seHelperRoad    = new Audio("mg_chan_effect.mp3"); 
      seLightning     = new Audio("lightning_strike.mp3");
      // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªåˆæœŸåŒ–
      feverBGM = new Audio("fever_bgm.mp3"); // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼BGMãƒ•ã‚¡ã‚¤ãƒ«å
      seFeverStart = new Audio("powerupGet.mp3"); // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼é–‹å§‹SEãƒ•ã‚¡ã‚¤ãƒ«å (ä»»æ„)
      seMakimonoGet = new Audio("powerupGet.mp3"); // â˜…å·»ç‰©å–å¾—éŸ³ (ä»®ã«ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—å–å¾—éŸ³ã‚’æµç”¨)

      bgm.loop=true;bgm.volume=.3;
      feverBGM.loop = true; feverBGM.volume = 0.35; // ãƒ•ã‚£ãƒ¼ãƒãƒ¼BGMè¨­å®š
    }catch(e){
      console.error("Audio init error:",e);
      const dummy={play:()=>{return Promise.resolve();},currentTime:0, pause:()=>{}}; // playãŒPromiseã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£
      seEggCollect=seTimePlus=seBomb=sePowerUp=seHelperMG=seHelperIkehaya=seHelperRoad=seLightning=seMakimonoGet=dummy;
      bgm={play:()=>Promise.resolve(),pause:()=>{},loop:true,volume:.3};
      // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ãƒ€ãƒŸãƒ¼ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª
      feverBGM = {play:()=>Promise.resolve(),pause:()=>{},loop:true,volume:0.35};
      seFeverStart = {play:()=>{return Promise.resolve();}};
    }
    try{highscore=parseInt(localStorage.getItem("rebornCatchHighscore"))||0}catch(e){}
    highscoreDisplay.textContent=highscore;

    function createBgBubbleParticle(){ /* å®Ÿè£…æ¸ˆã¿ */ }
    function createOuterShellParticle(){ /* å®Ÿè£…æ¸ˆã¿ */ }
    function createInGameTwinkleStars(count = 50) {
      if (!gameContainer) return;
      // å¤ã„æ˜Ÿã‚’å‰Šé™¤ (ãƒ•ã‚£ãƒ¼ãƒãƒ¼åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å†ç”Ÿæˆã™ã‚‹ãŸã‚)
      const existingStars = gameContainer.querySelectorAll('.game-bg-star');
      existingStars.forEach(star => star.remove());

      for (let i = 0; i < count; i++) {
        const starEl = document.createElement('div');
        starEl.className = 'game-bg-star';
        starEl.style.top = Math.random() * gameContainer.offsetHeight + 'px';
        starEl.style.left = Math.random() * gameContainer.offsetWidth + 'px';
        const size = 1 + Math.random() * (isFeverModeActive ? 2.5 : 2); // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯å°‘ã—å¤§ããã¦ã‚‚è‰¯ã„
        starEl.style.width = starEl.style.height = size + 'px';
        starEl.style.animationDelay = Math.random() * 4 + 's';
        // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯æ˜Ÿã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦ã‚‚å¤‰ãˆã‚‹ (CSSå´ã§ .fever-active .game-bg-star ã«ã¦è¨­å®šæ¸ˆ)
        starEl.style.animationDuration = (isFeverModeActive ? 1.5 + Math.random() * 1.5 : 3 + Math.random() * 3) + 's';
        if (isFeverModeActive) { // CSSå¤‰æ•°ã§ãƒ•ã‚£ãƒ¼ãƒãƒ¼æ™‚ã®æ˜Ÿã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®š
            starEl.style.setProperty('--fever-star-scale', (0.6 + Math.random() * 0.5).toFixed(2));
        }
        gameContainer.appendChild(starEl);
      }
    }


    const calcLevel=()=>Math.min(levelThresholds.filter(t=>score>=t).length,MAX_LEVEL);
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚„ä»–ã®é–¢æ•°ã®å®šç¾©ãŒã‚ã‚‹å ´æ‰€ã«ã€ã“ã® spawnRate é–¢æ•°ã‚’è¨˜è¿°ï¼ˆã¾ãŸã¯æ—¢å­˜ã®ã‚‚ã®ã‚’ç½®ãæ›ãˆï¼‰
ã€€ã€€ã€€ã€€const spawnRate = () => {
  let baseIntervalNormal = 800; 
  let baseIntervalFever = 200;  // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã®åŸºæœ¬å‡ºç¾é–“éš”ã‚’çŸ­ãï¼ˆä¾‹: 200msï¼‰
  
  let reductionPerLevel = 20;   
  let minIntervalNormal = 300;
  let minIntervalFever = 100; // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã®æœ€å°å‡ºç¾é–“éš”ã‚‚çŸ­ãï¼ˆä¾‹: 100msï¼‰

  let currentBaseInterval = isFeverModeActive ? baseIntervalFever : baseIntervalNormal;
  let currentMinInterval = isFeverModeActive ? minIntervalFever : minIntervalNormal;
  
  // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯ãƒ¬ãƒ™ãƒ«ã«ã‚ˆã‚‹å‡ºç¾é–“éš”ã®çŸ­ç¸®ã‚’ã•ã‚‰ã«ç·©ã‚„ã‹ã«ã™ã‚‹ã‹ã€å›ºå®šå€¤ã«ã—ã¦ã‚‚è‰¯ã„ã§ã™ã€‚
  // ã“ã“ã§ã¯ãƒ¬ãƒ™ãƒ«ã«ã‚ˆã‚‹çŸ­ç¸®ã‚‚é©ç”¨ã—ã¤ã¤ã€ãƒ™ãƒ¼ã‚¹ã¨æœ€å°å€¤ã‚’ã‚¢ã‚°ãƒ¬ãƒƒã‚·ãƒ–ã«ã—ã¦ã„ã¾ã™ã€‚
  let intervalReduction = isFeverModeActive ? (level - 1) * 10 : (level - 1) * reductionPerLevel; // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã®ãƒ¬ãƒ™ãƒ«å½±éŸ¿ã‚’å°‘ã—æ¸›ã‚‰ã™
  let interval = currentBaseInterval - intervalReduction; 

  return Math.max(currentMinInterval, interval);
};
    function updateScore(pt=1,type){
      // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¿®æ­£: ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã®ã‚¹ã‚³ã‚¢ã‚¢ãƒƒãƒ—
      if (isFeverModeActive) {
          pt = Math.ceil(pt * 2.5); // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯å¾—ç‚¹2.5å€ (èª¿æ•´å¯)
      } else if(isPowerUpActive) {
        pt*=2;
      }
      score+=pt;
      combo++;
      scoreDisplay.textContent=score;
      comboCountDisplay.textContent=combo;
      const prev=level;level=calcLevel();levelDisplay.textContent=level;
      if(level>prev)showLevelUp(level===MAX_LEVEL?`MAX LEVEL ${MAX_LEVEL} åˆ°é”!`:`LEVEL ${level}!`);
      if(combo>1)showComboPopup();
      if(pt>=5 && (type==="egg golden" || type === "feverBombPoints"))showSpecialEffect();
      if(combo>maxCombo)maxCombo=combo;

      checkAndSpawnFeverItem(); // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : æ¯ã‚¹ã‚³ã‚¢æ›´æ–°æ™‚ã«å‡ºç¾ãƒã‚§ãƒƒã‚¯
    }
    const resetCombo=()=>{
        // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¿®æ­£: ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯ã‚³ãƒ³ãƒœç¶™ç¶šã—ã‚„ã™ãï¼ˆãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼‰
        if (!isFeverModeActive) {
            combo=0;
            comboCountDisplay.textContent=combo;
        }
    };
    const showComboPopup=()=>{comboPopup.textContent=`${combo} COMBO!`;comboPopup.style.display='block';setTimeout(()=>comboPopup.style.display='none',1000)};
    const showLevelUp=msg=>{levelUpEffect.textContent=msg;levelUpEffect.style.display='block';setTimeout(()=>levelUpEffect.style.display='none',2000)};
    const showSpecialEffect=()=>{scoreDisplay.style.cssText="transform:scale(1.3);color:#D4AF37";setTimeout(()=>scoreDisplay.style.cssText="",500)};

    function getCurrentCharacterScale() {
    const isPowerUp = character.classList.contains("powerup"); // characterè¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªãŒã‚ˆã‚Šå®‰å…¨

    if (isFeverModeActive && isPowerUp) {
        return 1.75; // â˜…å¤‰æ›´ä¾‹: ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ + ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ä¸­ã®ã‚¹ã‚±ãƒ¼ãƒ«
    } else if (isFeverModeActive) {
        return 1.4;  // â˜…å¤‰æ›´ä¾‹: ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã®ã¿ã®ã‚¹ã‚±ãƒ¼ãƒ«
    } else if (isPowerUp) {
        return 1.5;  // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ä¸­ã®ã¿ã®ã‚¹ã‚±ãƒ¼ãƒ« (ã“ã‚Œã¯æ—¢å­˜ã®ã¾ã¾ã‹ã€ãŠå¥½ã¿ã§)
    }
    return 1; // é€šå¸¸æ™‚ã®ã‚¹ã‚±ãƒ¼ãƒ«
}

    function activatePowerUp(){
      if(isPowerUpActive){
        powerUpEndTime+=10000; 
        clearInterval(powerUpTimerId); 
      } else {
        isPowerUpActive=true;
        powerUpEndTime=Date.now()+10000;
        character.classList.add("powerup");
        // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¿®æ­£: ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã«ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã—ãŸå ´åˆã€ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚è€ƒæ…®
        if (isFeverModeActive) character.classList.add("fever-character");
        powerEffect.style.display='block';
      }
      // CSSã§ã‚¹ã‚±ãƒ¼ãƒ«ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§JSã§ã®ç›´æ¥æ“ä½œã¯ä¸è¦
      // character.style.transform = `translateX(-50%) scale(${getCurrentCharacterScale()})`;

      powerUpTimerId=setInterval(()=>{
        const remain=Math.ceil((powerUpEndTime-Date.now())/1000);
        if(remain<=0){deactivatePowerUp();clearInterval(powerUpTimerId)}
        else powerEffect.textContent=`ğŸ¤©ã‚¹ã‚³ã‚¢ï¼’å€ï¼(${remain}s)`;
      },100);
    }

    function deactivatePowerUp(){
      isPowerUpActive=false;
      character.classList.remove("powerup"); 
      // fever-characterã‚¯ãƒ©ã‚¹ã¯ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰å´ã§ç®¡ç†ã™ã‚‹ã®ã§ã“ã“ã§ã¯è§¦ã‚‰ãªã„
      powerEffect.style.display='none';
      clearInterval(powerUpTimerId);
      // ã‚¹ã‚±ãƒ¼ãƒ«ã¯CSSã‚¯ãƒ©ã‚¹(.powerupãŒå¤–ã‚Œã‚‹ã“ã¨ã§è‡ªå‹•çš„ã«æˆ»ã‚‹)ã«ä»»ã›ã‚‹
      // character.style.transform = `translateX(-50%) scale(${getCurrentCharacterScale()})`;
       if (!character.classList.contains("electrocuted")) {
         character.style.transform = ''; // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
      }
    }


    // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¿®æ­£: spawnMakimonoItemé–¢æ•°ã‚’createItemã®å¤–ã«å®šç¾©
    function spawnMakimonoItem() {
        if (timeLeft <= 0) return;

        const item = document.createElement("div");
        item.className = "makimono"; // CSSã‚¯ãƒ©ã‚¹è¨­å®š
        item.dataset.type = "makimono"; // ãƒ‡ãƒ¼ã‚¿å±æ€§ã§ã‚¿ã‚¤ãƒ—æŒ‡å®š
        const w = 55; // ã‚¢ã‚¤ãƒ†ãƒ å¹…

        // è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ä½ç½®è¨­å®š (createItemã¨å…±é€šåŒ–ã‚‚å¯èƒ½)
        const dur = Math.max(2.5, 3.5 + Math.random() * 1.5 - level * 0.1); // å°‘ã—ã‚†ã£ãã‚Šè½ã¡ã‚‹
        item.style.left = Math.random() * (gameContainer.offsetWidth - w) + "px";
        item.style.animationDuration = dur + "s";
        // fall-powerup ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æµç”¨ã€ã¾ãŸã¯å°‚ç”¨ã® fall-makimono ã‚’ä½œæˆ
        item.style.animationName = "fall-powerup"; 

        gameContainer.appendChild(item);

        // ãƒ’ãƒƒãƒˆåˆ¤å®š (createItemã®ã‚‚ã®ã‚’ãƒ™ãƒ¼ã‚¹ã«)
        const hit = setInterval(() => {
            if (!item.parentNode || timeLeft <= 0) {
                clearInterval(hit);
                if (item.parentNode) item.remove();
                return;
            }
            const a = item.getBoundingClientRect();
            const b = character.getBoundingClientRect();
            if (a.top < b.bottom && a.bottom > b.top && a.left < b.right && a.right > b.left) {
                // item.dataset.type ãŒ "makimono" ã®æ™‚ã®å‡¦ç†ã¯ createItem ã® switch case ã«é›†ç´„
                handleItemCollection(item); // handleItemCollection ã‚’å‘¼ã³å‡ºã™
                item.remove(); // å³åº§ã«æ¶ˆã™
                clearInterval(hit);
            }
        }, 30);

        setTimeout(() => {
            if (item.parentNode) item.remove();
            clearInterval(hit);
        }, dur * 1000 + 300);
    }
    
    // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¿®æ­£: handleItemCollectioné–¢æ•° (ã‚¢ã‚¤ãƒ†ãƒ å–å¾—æ™‚ã®å…±é€šå‡¦ç†)
    function handleItemCollection(itemElement) {
        const pts = parseInt(itemElement.dataset.points) || 0;
        const itemType = itemElement.dataset.type;

        switch (itemType) {
            case "bomb":
                if (isFeverModeActive) { // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯çˆ†å¼¾ãŒå¾—ç‚¹ã‚¢ã‚¤ãƒ†ãƒ ã«ãªã‚‹
                    updateScore(15, "feverBombPoints"); // ä¾‹:15ç‚¹
                    seEggCollect?.play().catch(e => console.error("Audio play error:", e));
                } else {
                    score = Math.max(0, score + pts);
                    scoreDisplay.textContent = score;
                    resetCombo();
                    seBomb?.play().catch(e => console.error("Audio play error:", e));
                    gameContainer.style.backgroundColor = "rgba(150,50,50,.7)"; // ä¸€ç¬èµ¤ã
                    setTimeout(() => { gameContainer.style.backgroundColor = isFeverModeActive ? "" : "#000";}, 150); // feverä¸­ã¯CSSã§èƒŒæ™¯ç®¡ç†
                }
                break;
            case "timePlus":
                timeLeft = Math.min(timeLeft + 5, MAX_TIME_LEFT);
                timerDisplay.textContent = timeLeft;
                seTimePlus?.play().catch(e => console.error("Audio play error:", e));
                break;
            case "powerup":
                sePowerUp?.play().catch(e => console.error("Audio play error:", e));
                activatePowerUp();
                break;
            case "helperIkehaya":
            case "helperRoad":
                updateScore(pts, itemType);
                seHelperMG?.play().catch(e => console.error("Audio play error:", e));
                // ãƒœãƒ é™¤å»ï¼ˆãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯ãƒœãƒ ãŒå¾—ç‚¹æºãªã®ã§é™¤å»ã—ãªã„æ–¹ãŒè‰¯ã„ã‹ã‚‚ã€‚ã“ã“ã§ã¯ãã®ã¾ã¾ï¼‰
                if (!isFeverModeActive) {
                    [...gameContainer.querySelectorAll(".bomb")].slice(0, 2).forEach(b => b.remove());
                }
                break;
            case "lightning":
                seLightning?.play().catch(e => console.error("Audio play error:", e));
                if (!isCharacterStunned && !isFeverModeActive) { // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯ã‚¹ã‚¿ãƒ³ã—ãªã„
                    isCharacterStunned = true;
                    character.style.setProperty('--current-scale', getCurrentCharacterScale());
                    character.classList.add("electrocuted");
                    if (stunTimeoutId) clearTimeout(stunTimeoutId);
                    stunTimeoutId = setTimeout(() => {
                        isCharacterStunned = false;
                        character.classList.remove("electrocuted");
                        character.style.removeProperty('--current-scale');
                         character.style.transform = ''; // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚¯ãƒªã‚¢
                    }, 3000);
                } else if (isFeverModeActive) { // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã«é›·ã‚’å–ã£ãŸã‚‰ãƒœãƒ¼ãƒŠã‚¹ã‚¹ã‚³ã‚¢
                    updateScore(20, "feverLightningBonus");
                    seEggCollect?.play().catch(e => console.error("Audio play error:", e));
                }
                break;
            case "makimono": // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : å·»ç‰©å–å¾—æ™‚ã®å‡¦ç†
                if (!isFeverModeActive) { // é‡è¤‡ç™ºå‹•é˜²æ­¢
                    seMakimonoGet?.play().catch(e => console.error("Audio play error:", e));
                    activateFeverMode();
                }
                break;
            case "feverBombPoints": // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã«ãƒœãƒ ãŒå¤‰åŒ–ã—ãŸã‚‚ã® (æ—¢ã«updateScoreã§å‡¦ç†æ¸ˆã¿ã®å ´åˆã‚‚ã‚ã‚‹ãŒå¿µã®ãŸã‚)
                 updateScore(pts, itemType); // updateScoreå†…ã§ãƒ•ã‚£ãƒ¼ãƒãƒ¼å€ç‡ãŒã‹ã‹ã‚‹
                 seEggCollect?.play().catch(e => console.error("Audio play error:", e));
                 break;
            default: // egg, egg special, egg golden
                updateScore(pts, itemType);
                seEggCollect?.play().catch(e => console.error("Audio play error:", e));
        }
    }

ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€function createItem () {
  if (timeLeft <= 0) return;

  let type; // ã‚¹ãƒãƒ¼ãƒ³ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¿ã‚¤ãƒ—ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°

  if (isFeverModeActive) {
    // --- â˜…â˜…â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯é‡‘ã®æ˜Ÿã®ã¿ â˜…â˜…â˜… ---
    type = "egg golden"; 
    // --- ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚¿ã‚¤ãƒ—æ±ºå®šã“ã“ã¾ã§ ---
  } else {
    // --- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ å‡ºç¾ãƒ­ã‚¸ãƒƒã‚¯ (å‰å›èª¿æ•´ã—ãŸã‚‚ã®ã€å¤‰æ›´ãªã—) ---
    const r = Math.random(); // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿ä¹±æ•°ã‚’ä½¿ç”¨
    let currentLevel = level;
    let bombProb, timePlusProb, lightningProb, powerUpProb;

    // (ãƒœãƒ ã€ã‚¿ã‚¤ãƒãƒ¼ã€ã‚«ãƒŸãƒŠãƒªã€ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã®ç¢ºç‡è¨ˆç®— - å‰å›ã¨åŒã˜)
    if (currentLevel >= 13) { bombProb = 0.08; } 
    else if (currentLevel >= 10) { bombProb = 0.10; } 
    else if (currentLevel >= 2) { bombProb = Math.min(0.05 + (currentLevel - 2) * 0.025, 0.12); } 
    else { bombProb = 0; }

    if (currentLevel >= 15) { timePlusProb = 0; } 
    else if (currentLevel >= 13) { timePlusProb = 0.02; } 
    else if (currentLevel >= 10) { timePlusProb = 0.04; } 
    else { timePlusProb = 0.08; }

    if (isFeverModeActive) { lightningProb = 0.02; } // ã“ã®elseãƒ–ãƒ­ãƒƒã‚¯ã§ã¯isFeverModeActiveã¯falseã®ã¯ãš
    else if (currentLevel >= 13) { lightningProb = 0.04; } 
    else if (currentLevel >= 10) { lightningProb = 0.06; } 
    else if (currentLevel >= 2) { lightningProb = Math.min(0.05 + (currentLevel - 2) * 0.01, 0.08); } 
    else { lightningProb = 0.05; }
    
    powerUpProb = (currentLevel >= 2) ? 0.07 : 0;

    const normalProbabilities = {
      bomb: bombProb,
      timePlus: timePlusProb,
      powerup: powerUpProb,
      helper: 0.06,       
      lightning: lightningProb,
      "egg golden": 0.10,  // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚é‡‘ã®æ˜Ÿã¯å‡ºã‚‹
      "egg special": 0.15,
      normalEgg: 0 
    };
    
    let totalDefinedProb = 0;
    for (const key in normalProbabilities) {
      if (key !== "normalEgg") { 
        totalDefinedProb += normalProbabilities[key];
      }
    }
    normalProbabilities.normalEgg = Math.max(0, 1.0 - totalDefinedProb); 

    let cumulativeProb = 0;
    let pickedNormalItem = false;
    const normalPickOrder = ["bomb", "lightning", "powerup", "helper", "timePlus", "egg special", "egg golden", "normalEgg"];

    for (const itemKey of normalPickOrder) {
      if (normalProbabilities.hasOwnProperty(itemKey)) {
        cumulativeProb += normalProbabilities[itemKey];
        if (r < cumulativeProb) {
          type = itemKey;
          pickedNormalItem = true;
          break;
        }
      }
    }
    if (!pickedNormalItem) { 
       type = "normalEgg"; 
    }
    // --- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ å‡ºç¾ãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§ ---
  }

  // --- ä»¥ä¸‹ã€ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆã®å…±é€šå‡¦ç† (å¤‰æ›´ãªã—) ---
  const item = document.createElement("div");
  let w;
  let itemClassName;
  let itemPoints = 0;
  let itemAnimationName = "fall-egg"; 

  let finalType = type; 
  if (type === "helper") { 
    const helpers = ["helperIkehaya", "helperRoad"];
    lastHelperIndex = (lastHelperIndex + 1) % helpers.length;
    finalType = helpers[lastHelperIndex]; 
  }

  switch (finalType) {
    case "bomb": itemClassName = "bomb"; itemPoints = -10; w = 40; itemAnimationName = "fall-bomb"; break;
    case "timePlus": itemClassName = "time-plus"; itemPoints = 0; w = 40; itemAnimationName = "fall-time-plus"; break;
    case "powerup": itemClassName = "power-up"; itemPoints = 0; w = 45; itemAnimationName = "fall-powerup"; break;
    case "helperIkehaya": itemClassName = "helper-ikehaya"; itemPoints = 25; w = 60; itemAnimationName = "fall-helper"; break;
    case "helperRoad": itemClassName = "helper-road"; itemPoints = 25; w = 60; itemAnimationName = "fall-helper"; break;
    case "lightning": itemClassName = "lightning"; itemPoints = 0; w = 45; itemAnimationName = "fall-bomb"; break;
    case "egg golden": itemClassName = "egg golden"; itemPoints = 5; w = 46; itemAnimationName = "fall-golden-egg"; break;
    case "egg special": itemClassName = "egg special"; itemPoints = 2; w = 38; itemAnimationName = "fall-special-egg"; break;
    default: 
        itemClassName = "egg"; itemPoints = 1; w = 30; itemAnimationName = "fall-egg"; finalType = "normalEgg";
  }
  item.className = itemClassName;
  item.dataset.points = String(itemPoints);
  item.dataset.type = finalType; 

  if (isFeverModeActive && finalType === "egg golden") { // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯é‡‘ã®æ˜Ÿã«ã‚°ãƒ­ãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    item.classList.add("fever-item-glow");
  }

  // ... (æ®‹ã‚Šã® createItem é–¢æ•°ã®å…±é€šå‡¦ç†ã¯å¤‰æ›´ãªã—) ...
  const dur = Math.max(1.5, 2.5 + Math.random() * 2 - level * 0.15);
  item.style.left            = Math.random() * (gameContainer.offsetWidth - w) + "px";
  item.style.animationDuration = dur + "s";
  item.style.animationName = itemAnimationName;

  item.style.setProperty("--start-rot-z",  ((Math.random() - .5) * 60).toFixed(1) + "deg");
  item.style.setProperty("--end-rot-z",    ((Math.random() - .5) * 90).toFixed(1) + "deg");
  item.style.setProperty("--random-rotate",      ((Math.random() - .5) * 70).toFixed(1) + "deg");
  item.style.setProperty("--random-rotate-half", ((Math.random() - .5) * 35).toFixed(1) + "deg");

  gameContainer.appendChild(item);

  const hit = setInterval(() => {
    if (!item.parentNode || timeLeft <= 0) { clearInterval(hit); if(item.parentNode)item.remove(); return; }
    const a = item.getBoundingClientRect();
    const b = character.getBoundingClientRect();
    if (a.top < b.bottom && a.bottom > b.top && a.left < b.right && a.right > b.left) {
      handleItemCollection(item); 
      item.remove(); 
      clearInterval(hit);
    }
  }, 30);

  setTimeout(() => {
    if (item.parentNode) {
      item.remove();
      if (item.classList.contains("egg") && !isFeverModeActive) resetCombo();
    }
    clearInterval(hit);
  }, dur * 1000 + 300);
}
    
    function startGame(){
      characterX=gameContainer.offsetWidth/2;character.style.left=characterX+"px";
      isCharacterStunned = false; 
      if (stunTimeoutId) clearTimeout(stunTimeoutId); 
      character.classList.remove("electrocuted"); 
      character.style.removeProperty('--current-scale'); 
      character.classList.remove("powerup");
      character.style.transform = ''; // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢

      // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ãƒ•ã‚£ãƒ¼ãƒãƒ¼é–¢é€£å¤‰æ•°ã®åˆæœŸåŒ–
      isFeverModeActive = false;
      if (feverModeTimerId) clearInterval(feverModeTimerId);
      feverModeTimerId = null;
      feverSpawnedLevel2 = false;
      feverSpawnedLevel5 = false;
      characterSpeedMultiplier = 1;
      gameContainer.classList.remove("fever-active");
      character.classList.remove("fever-character");
      if (feverBGM && typeof feverBGM.pause === 'function' && !feverBGM.paused) {
          feverBGM.pause();
          feverBGM.currentTime = 0;
      }
      originalBGMVolume = bgm.volume; // å…ƒã®BGMéŸ³é‡ã‚’ã“ã“ã§å–å¾—ãƒ»è¨­å®šã—ãªãŠã™

      bgm.currentTime = 0; // â˜…BGMã‚’æœ€åˆã‹ã‚‰å†ç”Ÿ
      bgm.play().catch(e => console.error("BGM play error:", e));
      createInGameTwinkleStars(isFeverModeActive ? 80 : 50); 
      itemSpawnerId=setInterval(createItem,spawnRate());
      gameBgParticleInterval=setInterval(createBgBubbleParticle,700);
      outerEffectInterval=setInterval(createOuterShellParticle,500);
      gameTimerId=setInterval(()=>{
        if(timeLeft<=0){
          clearInterval(gameTimerId);clearInterval(itemSpawnerId);
          clearInterval(gameBgParticleInterval);clearInterval(outerEffectInterval);
          if(powerUpTimerId)clearInterval(powerUpTimerId);
          if (stunTimeoutId) clearTimeout(stunTimeoutId);
          if (feverModeTimerId) clearInterval(feverModeTimerId); // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ 
          endGame();return;
        }
        timeLeft--;timerDisplay.textContent=timeLeft;
        // ã‚¹ã‚¿ãƒ³ä¸­ã‚„ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ãƒãƒ¼ãƒ³ãƒ¬ãƒ¼ãƒˆå¤‰æ›´ã¯spawnRate()é–¢æ•°å†…ã§å‡¦ç†
        if (!isCharacterStunned) {
            clearInterval(itemSpawnerId);itemSpawnerId=setInterval(createItem,spawnRate());
        }
      },1000);
    }
    function endGame(){
      bgm.pause();
      // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰ä¸­ãªã‚‰è§£é™¤
      if (isFeverModeActive) {
          deactivateFeverMode(false); // BGMã¯ãƒ¡ã‚¤ãƒ³ã«æˆ»ã•ãªã„ï¼ˆã‚²ãƒ¼ãƒ çµ‚äº†ãªã®ã§ï¼‰
      }
      if (feverBGM && typeof feverBGM.pause === 'function' && !feverBGM.paused) {
          feverBGM.pause();
          feverBGM.currentTime = 0;
      }

      finalScore.textContent=score;finalLevel.textContent=level;
      gameover.style.display="block";
      if(score>highscore){highscore=score;localStorage.setItem("rebornCatchHighscore",highscore);highscoreDisplay.textContent=highscore}
      
      const gameStars = gameContainer.querySelectorAll('.game-bg-star');
      gameStars.forEach(star => star.remove());

      [...gameContainer.children].forEach(c=>{
        if(!["character","gameover","combo-display-popup","level-up-effect","power-effect", "fever-mode-display"].includes(c.id)){ // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : fever-mode-displayã‚’é™¤å¤–
          // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¿®æ­£: .makimono ã‚‚å‰Šé™¤å¯¾è±¡ã«
          if(c.classList.contains("egg")||c.classList.contains("bomb")||c.classList.contains("power-up")||c.classList.contains("time-plus")||c.classList.contains("helper-mgchan")||c.classList.contains("helper-ikehaya")||c.classList.contains("helper-road")||c.classList.contains("lightning")||c.classList.contains("makimono")||c.classList.contains("bg-bubble-particle"))c.remove();
        }
      });
      pageWrapper.querySelectorAll('.outer-shell-particle').forEach(e=>e.remove());
      returnToSelectBtn.onclick=()=>location.href="character_select.html"; 
    }

    document.addEventListener("keydown",e=>{
      if(timeLeft<=0 || isCharacterStunned)return;
      const w=character.offsetWidth||120;
      const moveAmount = 30 * characterSpeedMultiplier; // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ç§»å‹•é€Ÿåº¦å¤‰æ›´
      if(e.key==="ArrowLeft"){characterX-=moveAmount}
      else if(e.key==="ArrowRight"){characterX+=moveAmount}
      else if(e.key===" "||e.key==="ArrowUp"){e.preventDefault();jump()}
      characterX=Math.max(w/2,Math.min(gameContainer.offsetWidth-w/2,characterX));
      character.style.left=characterX+"px";
    });

    function jump(){ 
      if(character.classList.contains("jump")||timeLeft<=0 || isCharacterStunned)return;
      character.style.setProperty('--current-scale', getCurrentCharacterScale()); // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¿®æ­£: ç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚’é©ç”¨
      character.classList.add("jump"); // jump-animã‚¯ãƒ©ã‚¹ã«å¤‰æ›´æ¸ˆã¿
      setTimeout(()=>{
          character.classList.remove("jump");
          character.style.removeProperty('--current-scale');
      },600);
    }
    character.addEventListener("click",e=>{if(timeLeft>0 && !isCharacterStunned){e.preventDefault();jump()}},{passive:false});


    const leftBtn=document.createElement("button"),rightBtn=document.createElement("button");
    leftBtn.textContent="â—€";rightBtn.textContent="â–¶";
    leftBtn.className=rightBtn.className="control-btn";
    leftBtn.style.left="20px";rightBtn.style.right="20px";
    pageWrapper.append(leftBtn,rightBtn);

    let moveInt=null;
    const startMove=dir=>{
      if(moveInt||timeLeft<=0 || isCharacterStunned)return;
      const w=character.offsetWidth||120;
      const baseMoveSpeed = 15;
      const moveAmount = baseMoveSpeed * characterSpeedMultiplier; // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ç§»å‹•é€Ÿåº¦å¤‰æ›´
      moveInt=setInterval(()=>{
        characterX+=(dir==="left"?-moveAmount:moveAmount);
        characterX=Math.max(w/2,Math.min(gameContainer.offsetWidth-w/2,characterX));
        character.style.left=characterX+"px";
      },30);
    };
    const stopMove=()=>{clearInterval(moveInt);moveInt=null};
    leftBtn.addEventListener("touchstart",e=>{e.preventDefault();if(!isCharacterStunned)startMove("left")},{passive:false});
    rightBtn.addEventListener("touchstart",e=>{e.preventDefault();if(!isCharacterStunned)startMove("right")},{passive:false});
    leftBtn.onmousedown=()=>{if(!isCharacterStunned)startMove("left")};
    rightBtn.onmousedown=()=>{if(!isCharacterStunned)startMove("right")};
    ["mouseup","touchend"].forEach(ev=>document.addEventListener(ev,stopMove,{passive:false}));

    let sx=null,sy=null,thr=30;
    const relX=cl=>cl-gameContainer.getBoundingClientRect().left;
    gameContainer.addEventListener("touchstart",e=>{
      if(timeLeft<=0 || isCharacterStunned)return;
      const t=e.changedTouches[0];sx=relX(t.clientX);sy=t.clientY;
    },{passive:true});
    gameContainer.addEventListener("touchmove",e=>{
      // â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ã‚¹ãƒ¯ã‚¤ãƒ—ç§»å‹•ã‚‚é€Ÿåº¦å€ç‡ã‚’é©ç”¨ï¼ˆãŠå¥½ã¿ã§èª¿æ•´ï¼‰
      const swipeMultiplier = isFeverModeActive ? 1.2 : 1; // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯ã‚¹ãƒ¯ã‚¤ãƒ—æ„Ÿåº¦å°‘ã—ã‚¢ãƒƒãƒ—
      if(timeLeft<=0||sx==null || isCharacterStunned)return;
      const x=relX(e.changedTouches[0].clientX),dx=(x-sx) * swipeMultiplier; characterX+=dx;sx=x;
      const w=character.offsetWidth||120;
      characterX=Math.max(w/2,Math.min(gameContainer.offsetWidth-w/2,characterX));
      character.style.left=characterX+"px";
    },{passive:true});
    gameContainer.addEventListener("touchend",e=>{
      if(timeLeft<=0||sx==null||sy==null || isCharacterStunned){sx=sy=null;return}
      const dx=relX(e.changedTouches[0].clientX)-sx,dy=e.changedTouches[0].clientY-sy;
      if(Math.abs(dy)>Math.abs(dx)&&dy<-thr)jump();
      sx=sy=null;
    },{passive:true});

    window.addEventListener('resize',()=>{ const w=character.offsetWidth||120; characterX=Math.max(w/2,Math.min(gameContainer.offsetWidth-w/2,characterX)); character.style.left=characterX+"px"; });
    const tryPlay=()=>{ bgm.play().then(()=>{ document.body.removeEventListener('click',tryPlay); document.body.removeEventListener('touchstart',tryPlay); }).catch(()=>{}); };
    document.body.addEventListener('click',tryPlay,{once:true});
    document.body.addEventListener('touchstart',tryPlay,{once:true});

    // =============== â˜…ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¿½åŠ : ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰é–¢é€£é–¢æ•° ===============
    function checkAndSpawnFeverItem() {
        if (isFeverModeActive || timeLeft <= 0) return;

        const conditionsMetLevel2 = (level === 2 && combo >= 15 && !feverSpawnedLevel2);
        const conditionsMetLevel5 = (level === 5 && combo >= 60 && !feverSpawnedLevel5);

        if (conditionsMetLevel2) {
            feverSpawnedLevel2 = true;
            spawnMakimonoItem(); // å·»ç‰©ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¹ãƒãƒ¼ãƒ³
        } else if (conditionsMetLevel5) {
            feverSpawnedLevel5 = true;
            spawnMakimonoItem(); // å·»ç‰©ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¹ãƒãƒ¼ãƒ³
        }
    }

    function activateFeverMode() {
        if (isFeverModeActive) return; // é‡è¤‡ç™ºå‹•é˜²æ­¢

        isFeverModeActive = true;
        feverModeEndTime = Date.now() + FEVER_DURATION;

        seFeverStart?.play().catch(e => console.error("Audio play error:", e));

        bgm.pause();
        feverBGM.currentTime = 0;
        feverBGM.play().catch(e => console.error("Fever BGM play error:", e));

        gameContainer.classList.add("fever-active");
        character.classList.add("fever-character");
        character.style.transform = `translateX(-50%) scale(${getCurrentCharacterScale()})`; //ã‚¹ã‚±ãƒ¼ãƒ«æ›´æ–°

        feverModeDisplay.style.display = 'block';
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯CSSã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€è¡¨ç¤ºå¾Œè‡ªå‹•ã§æ¶ˆãˆã‚‹
        setTimeout(() => {
            if (feverModeDisplay) feverModeDisplay.style.display = 'none';
        }, 2500); // CSSã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã¨åˆã‚ã›ã‚‹

        createInGameTwinkleStars(isFeverModeActive ? 80 : 50); // æ˜Ÿã‚’å¢—ã‚„ã™ãªã©

        characterSpeedMultiplier = 1.6; // ç§»å‹•é€Ÿåº¦ã‚¢ãƒƒãƒ— (èª¿æ•´å¯)

        // æ—¢å­˜ã®çˆ†å¼¾ã‚’ãƒ•ã‚£ãƒ¼ãƒãƒ¼ç”¨å¾—ç‚¹ã‚¢ã‚¤ãƒ†ãƒ ã«å¤‰æ›´
        const existingBombs = gameContainer.querySelectorAll(".bomb");
        existingBombs.forEach(bombNode => {
            bombNode.className = "egg golden fever-item-glow"; // é‡‘ã®åµ + å…‰ã‚‹ã‚¯ãƒ©ã‚¹
            bombNode.dataset.points = "10"; // 10ç‚¹ã‚¢ã‚¤ãƒ†ãƒ ã« (å¾—ç‚¹ã¯updateScoreã§ãƒ•ã‚£ãƒ¼ãƒãƒ¼å€ç‡ãŒã‹ã‹ã‚‹)
            bombNode.dataset.type = "feverBombPoints";
            if (bombNode.firstChild && bombNode.firstChild.nodeType === Node.ELEMENT_NODE && bombNode.firstChild.tagName === '::before') {
                 // bomb::before ã¯JSã§ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹é›£ã—ã„ã®ã§ã€classNameå¤‰æ›´ã§è¦‹ãŸç›®ã‚’å¤‰ãˆã‚‹
            } else {
                 bombNode.innerHTML = ''; // ğŸ’£ã‚’æ¶ˆã™ (ç›´æ¥ã®å­è¦ç´ ã®å ´åˆ)
            }
             // å¿…è¦ã§ã‚ã‚Œã°ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã‚‚ãƒªã‚»ãƒƒãƒˆãƒ»å¤‰æ›´
            const dur = Math.max(1.5, 2.5 + Math.random() * 2 - level * 0.15);
            bombNode.style.animationDuration = dur + "s";
            bombNode.style.animationName = "fall-golden-egg"; // é‡‘åµã®è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        });


        feverModeTimerId = setInterval(() => {
            const timeLeftFever = Math.ceil((feverModeEndTime - Date.now()) / 1000);
            if (timeLeftFever <= 0 || timeLeft <= 0) {
                deactivateFeverMode();
            }
            // ã“ã“ã§ãƒ•ã‚£ãƒ¼ãƒãƒ¼æ®‹ã‚Šæ™‚é–“ã‚’è¡¨ç¤ºã—ã¦ã‚‚è‰¯ã„ (ä¾‹: powerEffectã¨åŒæ§˜ã«)
        }, 100);
        
        // ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ãƒãƒŠãƒ¼ã®é–“éš”ã‚’æ›´æ–°
        clearInterval(itemSpawnerId);
        itemSpawnerId = setInterval(createItem, spawnRate());
    }

    function deactivateFeverMode(switchToMainBGM = true) {
        if (!isFeverModeActive) return;

        isFeverModeActive = false;
        if(feverModeTimerId) clearInterval(feverModeTimerId);
        feverModeTimerId = null;

        if (switchToMainBGM) {
            feverBGM.pause();
            bgm.volume = originalBGMVolume;
            bgm.currentTime = 0; 
            bgm.play().catch(e => console.error("Main BGM resume error:", e));
        }

        gameContainer.classList.remove("fever-active");
        character.classList.remove("fever-character");
        character.style.transform = `translateX(-50%) scale(${getCurrentCharacterScale()})`; //ã‚¹ã‚±ãƒ¼ãƒ«æ›´æ–°

        createInGameTwinkleStars(50);

        characterSpeedMultiplier = 1;
        
        // ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ãƒãƒŠãƒ¼ã®é–“éš”ã‚’æ›´æ–°
        clearInterval(itemSpawnerId);
        itemSpawnerId = setInterval(createItem, spawnRate());
    }

    startGame();
  </script>
</body>
</html>
â€¨â€¨
