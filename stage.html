<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CNP-CATCH</title>
  <style>
    /* CSSは変更なし */
    *{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
    body{
      width:100vw;height:100vh;overflow:hidden;
      font-family:'Noto Sans JP',sans-serif;
      touch-action:manipulation;-webkit-overflow-scrolling:touch;
    }
    #page-wrapper{
      width:100%;height:100%;
      background:#000;
      display:flex;justify-content:center;align-items:center;
      position:relative;overflow:hidden;
    }
    #game-container{
      position:relative;width:100%;max-width:380px;height:100%;
      background:#000;
      overflow:hidden;
      transition: box-shadow 0.3s ease-in-out; 
    }
    .bg-bubble-particle{position:absolute;border-radius:50%;pointer-events:none;animation:float-bubble linear infinite;z-index:1;opacity:0}
    .bg-bubble-particle.yellow{background:rgba(255,215,0,.15)}
    .bg-bubble-particle.white{background:rgba(255,250,240,.12)}
    @keyframes float-bubble{
      0%{transform:translateY(105%) scale(var(--bubble-scale));opacity:0}
      20%,80%{opacity:var(--bubble-opacity)}
      100%{transform:translateY(-10%) scale(var(--bubble-scale));opacity:0}
    }
    .outer-shell-particle{
      position:absolute;pointer-events:none;opacity:0;z-index:5;
      background:rgba(245,222,179,.3);
      width:var(--shell-width);height:var(--shell-height);
      border-radius:30% 70% 20% 80%/50% 40% 60% 50%;
      animation:fall-outer-shell linear infinite;
    }
    @keyframes fall-outer-shell{
      0%{transform:translateY(-10vh) translateX(var(--outer-start-x)) rotateZ(0) rotateY(var(--outer-rotate-y-start));opacity:0}
      10%,90%{opacity:.5}
      100%{transform:translateY(110vh) translateX(var(--outer-end-x)) rotateZ(var(--outer-rotate-z-end)) rotateY(var(--outer-rotate-y-end));opacity:0}
    }
    @keyframes game-twinkle {
      0%, 100% { transform: scale(.3); opacity: 0; }
      10%      { opacity: .6; }
      50%      { opacity: .8; transform: scale(.5); }
      90%      { opacity: .6; }
    }
    .game-bg-star {
      position: absolute;
      width: 2px;
      height: 2px;
      border-radius: 50%;
      background: #fff;
      pointer-events: none;
      animation: game-twinkle 4s linear infinite;
      filter: drop-shadow(0 0 2px #fff) drop-shadow(0 0 4px #fff);
      z-index: 0;
    }
    #character{
      position:absolute;bottom:80px;left:50%;
      transform:translateX(-50%) scale(1);
      max-height:20vh;max-width:100px;height:auto;z-index:50;
      filter:drop-shadow(2px 4px 8px rgba(0,0,0,.2));
      transition: transform 0.2s ease-out, filter 0.2s ease-out;
    }
    #character.jump{
        animation:jump-anim .6s ease;
    }
    #character.powerup{
      filter:drop-shadow(0 0 15px #FFD700) drop-shadow(2px 4px 8px rgba(0,0,0,.2));
      transform:translateX(-50%) scale(1.5);
    }
    #character.fever-character {}
    #character.powerup.fever-character {
      transform: translateX(-50%) scale(1.65); 
      animation: character-fever-powerup-aura 0.25s infinite alternate;
    }
    @keyframes character-fever-powerup-aura { 
        0% { filter: drop-shadow(0 0 15px red) drop-shadow(0 0 20px orange) drop-shadow(0 0 25px yellow) drop-shadow(2px 4px 8px rgba(0,0,0,.2)); }
        50% { filter: drop-shadow(0 0 25px yellow) drop-shadow(0 0 30px gold) drop-shadow(0 0 35px orangered) drop-shadow(2px 4px 8px rgba(0,0,0,.2)); }
        100% { filter: drop-shadow(0 0 15px orangered) drop-shadow(0 0 20px yellow) drop-shadow(0 0 25px gold) drop-shadow(2px 4px 8px rgba(0,0,0,.2)); }
    }
    #character.fever-character:not(.powerup) {
        animation: character-fever-only-aura 0.3s infinite alternate;
    }
    @keyframes character-fever-only-aura {
        0% { filter: drop-shadow(0 0 15px #ff00ff) drop-shadow(0 0 20px #ff00ff) drop-shadow(2px 4px 8px rgba(0,0,0,.2)); }
        100% { filter: drop-shadow(0 0 20px #ff00ff) drop-shadow(0 0 25px #ee82ee) drop-shadow(2px 4px 8px rgba(0,0,0,.2)); }
    }
    @keyframes jump-anim{ 
      0% { transform: translateX(-50%) translateY(0) scale(var(--current-scale, 1)); }
      30%, 60% { transform: translateX(-50%) translateY(-60px) scale(var(--current-scale, 1)); }
      100% { transform: translateX(-50%) translateY(0) scale(var(--current-scale, 1)); }
    }
    #character.electrocuted {
      animation: electric-shock 0.08s infinite;
    }
    @keyframes electric-shock {
      0% { transform: translateX(-51%) rotate(-2deg) scale(var(--current-scale, 1)); }
      25% { transform: translateX(-49%) rotate(2deg) scale(var(--current-scale, 1)); }
      50% { transform: translateX(-51%) rotate(-1deg) scale(var(--current-scale, 1)); }
      75% { transform: translateX(-49%) rotate(1deg) scale(var(--current-scale, 1)); }
      100% { transform: translateX(-50%) rotate(0deg) scale(var(--current-scale, 1)); }
    }
    .egg,.bomb,.power-up,.time-plus,.helper-mgchan,.helper-ikehaya,.helper-road, .lightning, .makimono {
      position:absolute;pointer-events:none;z-index:40;
      background-position:center;background-repeat:no-repeat;background-size:contain;
    }
    .egg{
      --start-rot-z: 0deg;
      --end-rot-z  : 0deg;
      background-color: #fff;
      width:30px;
      height:30px;
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      animation-name:fall-egg;animation-timing-function:linear;
      filter:drop-shadow(0 2px 2px rgba(0,0,0,.15));
    }
    .egg.special{
      background-color: #87CEEB;
      width:38px;
      height:38px;
      animation-name:fall-special-egg;animation-timing-function:linear;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,.2));
    }
    .egg.golden{
      background-color: #FFD700;
      width:46px;
      height:46px;
      animation-name:fall-golden-egg;animation-timing-function:linear;
      filter:drop-shadow(0 0 15px gold) drop-shadow(0 0 5px white);
    }
    .makimono {
      width: 55px;
      height: 55px;
      background-image: url("makimono.webp"); 
      animation-name: fall-powerup; 
      filter: drop-shadow(0 0 10px #ffd700) drop-shadow(0 0 15px #ff8c00) drop-shadow(0 0 5px #ffffff);
      z-index: 45; 
    }
    .fever-item-glow {
      filter: drop-shadow(0 0 8px #FFD700) drop-shadow(0 0 15px #FFA500) drop-shadow(0 0 5px #ffffff) !important;
      transform: scale(1.1); 
    }
    .helper-mgchan{
      width:60px;height:60px;
      background-image:url("MG Chan.PNG");
      animation-name:fall-helper;animation-timing-function:linear;
      border-radius:15px;
      filter:drop-shadow(0 3px 5px rgba(0,0,0,.3));
    }
    .helper-ikehaya, .helper-road {
      width:60px;
      height:60px;
      animation-name:fall-helper;
      animation-timing-function:linear;
      border-radius:15px;
      filter:drop-shadow(0 3px 5px rgba(0,0,0,.3));
    }
    .helper-ikehaya {
      background-image:url("ikehaya.webp");
    }
    .helper-road {
      background-image:url("Road.webp");
    }
    .bomb{
      width:40px;height:40px;
      background:radial-gradient(circle,#5a3d32 0%,#3e2723 70%,#2d1b17 100%);
      border-radius:50%;
      filter:drop-shadow(0 0 10px rgba(40,20,10,.8));
      animation-name:fall-bomb;animation-timing-function:linear;
    }
    .bomb::before{
      content:'💣';position:absolute;top:50%;left:50%;
      transform:translate(-50%,-50%);
      font-size:28px;color:#FF4500;text-shadow:0 0 5px #FF0000;
      animation:bomb-pulse .5s infinite alternate;
    }
    .power-up{
      width:45px;height:45px;border-radius:50%;
      background:linear-gradient(45deg,#FFD700,#FFA500,#FF8C00,#FF7F50,#FF6347);
      filter:drop-shadow(0 0 15px rgba(255,165,0,.8));
      animation:fall-powerup linear 1,var(--dummy,1s) ease infinite;
    }
    .power-up::before{
      content:'🌟';position:absolute;top:50%;left:50%;
      transform:translate(-50%,-50%);font-size:25px;
      animation:star-spin 1.5s linear infinite;
    }
    .time-plus{
      width:40px;height:40px;border-radius:50%;
      background:radial-gradient(circle,#F0E68C 0%,#EEE8AA 50%,#BDB76B 100%);
      filter:drop-shadow(0 0 8px rgba(218,165,32,.7));
      animation:fall-time-plus linear;
    }
    .time-plus::before{
      content:'⏱️';position:absolute;top:50%;left:50%;
      transform:translate(-50%,-50%);font-size:25px;
      animation:time-pulse 1.5s ease-in-out infinite alternate;
    }
    .lightning {
      width: 45px;
      height: 45px;
      font-size: 38px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #FFFF00;
      text-shadow: 0 0 5px #FFD700, 0 0 10px #FFEA00;
      animation-name: fall-bomb; 
      animation-timing-function: linear;
      filter: drop-shadow(0 0 8px gold);
    }
    .lightning::before {
      content: '⚡️';
    }
    #scoreboard,#level-display,.control-btn,.power-effect,.combo-display,.level-up-effect{position:fixed;z-index:200}
    #scoreboard{top:15px;right:20px;font-size:14px;font-weight:bold;color:#604020;background:linear-gradient(145deg,#fff8dc 0%,#ffefd5 100%);padding:15px 20px;border-radius:20px;line-height:1.6;box-shadow:0 8px 24px rgba(0,0,0,.1),0 4px 8px rgba(139,69,19,.2);border:2px solid rgba(210,180,140,.5);backdrop-filter:blur(10px);min-width:180px;}
    #level-display{top:15px;left:20px;font-size:16px;font-weight:bold;color:#604020;background:linear-gradient(145deg,#fff8dc 0%,#ffefd5 100%);padding:12px 18px;border-radius:15px;box-shadow:0 4px 12px rgba(0,0,0,.1),0 2px 4px rgba(139,69,19,.2);border:2px solid rgba(210,180,140,.5);backdrop-filter:blur(5px);}
    .combo-display{top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;font-weight:bold;color:#FF8C00;background:rgba(60,30,10,.85);padding:10px 20px;border-radius:15px;display:none;animation:combo-pop 1s ease-out;text-shadow:1px 1px 2px rgba(255,255,255,.3);z-index:210;}
    #gameover{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:28px;font-weight:bold;background:linear-gradient(145deg,rgba(80,50,20,.9),rgba(50,30,10,.85));color:#fff8dc;padding:30px;border-radius:20px;display:none;z-index:150;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.5);border:2px solid rgba(210,180,140,.3);width:90%;max-width:380px;}
    #return-to-select-btn{background:#D2691E;color:#fff;border:none;padding:12px 25px;margin-top:25px;font-size:16px;border-radius:8px;cursor:pointer;transition:.3s;}
    #return-to-select-btn:hover{background:#A0522D}
    .control-btn{bottom:15px;width:55px;height:55px;font-size:22px;border-radius:50%;border:none;background:linear-gradient(145deg,rgba(210,180,140,.9) 0%,rgba(139,69,19,.8) 100%);color:#fff;cursor:pointer;box-shadow:0 6px 18px rgba(139,69,19,.4),0 3px 6px rgba(0,0,0,.2);border:2px solid rgba(255,255,255,.4);transition:.2s;}
    .control-btn:active{transform:scale(.95);box-shadow:0 3px 9px rgba(139,69,19,.4),0 1px 3px rgba(0,0,0,.2)}
    .power-effect{bottom:150px;left:20px;padding:8px 16px;font-size:14px;font-weight:bold;background:linear-gradient(45deg,#FFA500,#FF4500);color:#fff;border-radius:20px;display:none;animation:power-glow .5s ease-in-out infinite alternate;}
    .level-up-effect{top:30%;left:50%;transform:translate(-50%,-50%);font-size:32px;font-weight:bold;color:#CD853F;background:linear-gradient(45deg,rgba(255,228,181,.9),rgba(255,218,185,.8));padding:20px 40px;border-radius:20px;display:none;animation:level-up-animation 2s ease-out;text-shadow:1px 1px 2px rgba(100,50,0,.5);border:3px solid rgba(255,255,255,.8);z-index:210;}
    #game-container.fever-active {
      animation: fever-glow-animation 0.4s infinite alternate;
    }
    @keyframes fever-glow-animation {
      from { box-shadow: 0 0 25px #FFD700, 0 0 35px #FF8C00 inset, 0 0 30px #FFFACD; }
      to   { box-shadow: 0 0 40px #FFA500, 0 0 50px #FF4500 inset, 0 0 45px #FFD700; }
    }
    #fever-mode-display {
      position: fixed; 
      top: 35%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 38px; font-weight: bold;
      color: #fff;
      background: linear-gradient(45deg, #ff1493, #ff69b4, #ff7f50, #ffa500, #ffd700);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      padding: 15px 30px; border-radius: 20px;
      text-shadow: 0 0 5px rgba(255,255,255,0.8), 0 0 10px #ff8c00, 0 0 15px #ff4500;
      border: 3px solid;
      border-image-slice: 1;
      border-image-source: linear-gradient(to right, gold, orangered);
      box-shadow: 0 0 20px rgba(255,100,0,0.7);
      display: none; 
      z-index: 220;
      animation: fever-text-pop-anim 2.5s ease-out forwards;
    }
    @keyframes fever-text-pop-anim {
      0% { transform: translate(-50%, -50%) scale(0.3) rotate(-15deg); opacity: 0; }
      20% { transform: translate(-50%, -50%) scale(1.2) rotate(5deg); opacity: 1; }
      80% { transform: translate(-50%, -50%) scale(1.1) rotate(0deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1.1) rotate(0deg); opacity: 0; }
    }
    #game-container.fever-active .game-bg-star {
        animation-duration: 0.8s !important; 
        filter: drop-shadow(0 0 4px #FFD700) drop-shadow(0 0 8px #FFD700) drop-shadow(0 0 2px #FFFFFF);
        background: #FFFACD; 
        transform: scale(var(--fever-star-scale, 0.7)); 
    }
    @keyframes bomb-pulse{0%{transform:translate(-50%,-50%) scale(1)}100%{transform:translate(-50%,-50%) scale(1.2)}}
    @keyframes star-spin{0%{transform:translate(-50%,-50%) rotate(0) scale(1)}50%{transform:translate(-50%,-50%) rotate(180deg) scale(1.2)}100%{transform:translate(-50%,-50%) rotate(360deg) scale(1)}}
    @keyframes rainbow-rotate-warm{0%{filter:drop-shadow(0 0 15px rgba(255,165,0,.8)) hue-rotate(0)}100%{filter:drop-shadow(0 0 15px rgba(255,165,0,.8)) hue-rotate(45deg)}}
    @keyframes power-glow{0%{box-shadow:0 0 10px rgba(255,165,0,.8)}100%{box-shadow:0 0 20px rgba(255,120,0,1)}}
    @keyframes level-up-animation{0%{transform:translate(-50%,-50%) scale(.5) rotate(-10deg);opacity:0}30%{transform:translate(-50%,-50%) scale(1.2) rotate(5deg);opacity:1}70%{transform:translate(-50%,-50%) scale(1.1) rotate(-2deg);opacity:1}100%{transform:translate(-50%,-50%) scale(1) rotate(0);opacity:0}}
    @keyframes time-pulse{0%{transform:translate(-50%,-50%) scale(1) rotate(0);opacity:.8}50%{transform:translate(-50%,-50%) scale(1.15) rotate(5deg);opacity:1}100%{transform:translate(-50%,-50%) scale(1) rotate(0);opacity:.8}}
    @keyframes fall-egg{0%{transform:translateY(-70px) rotateZ(var(--start-rot-z)) scale(.8);opacity:.6}100%{transform:translateY(105vh) rotateZ(var(--end-rot-z));opacity:1}}
    @keyframes fall-special-egg{0%{transform:translateY(-60px) rotateZ(0) scale(.9);opacity:.8}50%{transform:translateY(50vh) rotateZ(90deg) scale(1.1)}100%{transform:translateY(105vh) rotateZ(180deg) scale(.9);opacity:1}}
    @keyframes fall-golden-egg{0%{transform:translateY(-60px) rotateZ(0) scale(1);opacity:.9}25%{transform:translateY(25vh) rotateZ(var(--random-rotate-half)) scale(1.15)}100%{transform:translateY(105vh) rotateZ(var(--random-rotate)) scale(1);opacity:1}}
    @keyframes fall-helper{0%{transform:translateY(-80px) scale(.7) rotate(-15deg);opacity:.7}50%{transform:translateY(40vh) scale(1) rotate(15deg);opacity:1}100%{transform:translateY(105vh) scale(.8) rotate(5deg);opacity:.9}}
    @keyframes fall-bomb{0%{transform:translateY(-50px) rotate(0) scale(1);opacity:1}30%{transform:translateY(30vh) rotate(-20deg) scale(1.05)}60%{transform:translateY(60vh) rotate(15deg) scale(1.1)}100%{transform:translateY(100vh) rotate(10deg) scale(1);opacity:1}}
    @keyframes fall-powerup{0%{transform:translateY(-50px) scale(.8);opacity:.8}25%{transform:translateY(25vh) scale(1.1);opacity:1}50%{transform:translateY(50vh) scale(1.2)}75%{transform:translateY(75vh) scale(1.1)}100%{transform:translateY(100vh) scale(1);opacity:1}}
    @keyframes fall-time-plus{0%{transform:translateY(-50px) translateX(0) rotate(0) scale(.9);opacity:.7}25%{transform:translateY(25vh) translateX(10px) rotate(5deg) scale(1);opacity:1}50%{transform:translateY(50vh) translateX(-10px) rotate(-5deg) scale(1.1)}75%{transform:translateY(75vh) translateX(5px) rotate(2deg) scale(1)}100%{transform:translateY(100vh) translateX(0) rotate(0) scale(.9);opacity:1}}
  </style>
</head>
<body>
  <div id="page-wrapper">
    <div id="game-container">
      <img id="character" src="" alt="キャラクター">
      <div id="gameover">
        <div>ゲーム終了！</div>
        <div style="font-size:18px;margin-top:10px">
          最終スコア:<span id="final-score">0</span><br>
          到達レベル:<span id="final-level">1</span>
        </div>
        <button id="return-to-select-btn">キャラクター選択に戻る</button>
      </div>
      <div class="combo-display" id="combo-display-popup"></div>
      <div class="level-up-effect" id="level-up-effect"></div>
      <div class="power-effect"  id="power-effect"></div>
      <div id="fever-mode-display">FEVER TIME!</div>
    </div>
  </div>
  <div id="scoreboard">スコア:<span id="score">0</span><br>ハイスコア:<span id="highscore">0</span><br>残り:<span id="timer">60</span>秒<br>コンボ:<span id="combo">0</span></div>
  <div id="level-display">レベル:<span id="level">1</span></div>
  <script>
    function log(message) {
        console.log(`[GAME LOG] ${new Date().toLocaleTimeString()}: ${message}`);
    }

    // ★デバッグログ強化: DOM要素の状態をログ出力する関数
    function logElementState(elementName, elementRef) {
        if (elementRef) {
            log(`${elementName} - classes: ${elementRef.className}, left: ${elementRef.style.left}, bottom: ${elementRef.style.bottom}, top: ${elementRef.style.top}, transform: ${elementRef.style.transform}, display: ${elementRef.style.display}`);
            log(`${elementName} - offsetLeft: ${elementRef.offsetLeft}, offsetTop: ${elementRef.offsetTop}, offsetWidth: ${elementRef.offsetWidth}, offsetHeight: ${elementRef.offsetHeight}`);
        } else {
            log(`${elementName} is null or undefined.`);
        }
    }


    document.addEventListener('contextmenu',e=>{e.preventDefault()},{passive:false});
    document.addEventListener('selectstart',e=>{e.preventDefault()},{passive:false});
    document.addEventListener('dragstart',e=>{e.preventDefault()},{passive:false});

    const pageWrapper          = document.getElementById("page-wrapper");
    const gameContainer        = document.getElementById("game-container");
    const character            = document.getElementById("character");
    const scoreDisplay         = document.getElementById("score");
    const highscoreDisplay     = document.getElementById("highscore");
    const timerDisplay         = document.getElementById("timer");
    const levelDisplay         = document.getElementById("level");
    const comboCountDisplay    = document.getElementById("combo");
    const comboPopup           = document.getElementById("combo-display-popup");
    const powerEffect          = document.getElementById("power-effect");
    const levelUpEffect        = document.getElementById("level-up-effect");
    const gameover             = document.getElementById("gameover");
    const finalScore           = document.getElementById("final-score");
    const finalLevel           = document.getElementById("final-level");
    const returnToSelectBtn    = document.getElementById("return-to-select-btn");
    const feverModeDisplay     = document.getElementById("fever-mode-display"); 

    const selectedImageFile = localStorage.getItem("selectedImage");
    const selectedCharName  = localStorage.getItem("selectedName");
    if(selectedImageFile && selectedCharName && character){ // character存在確認
      character.src = selectedImageFile;
      character.alt = selectedCharName;
    }else if (character) { // character存在確認
      character.src = "Leeleeg.webp"; 
      character.alt = "Leelee";    
    }

    let score=0,highscore=0,timeLeft=60;
    const MAX_TIME_LEFT=90,MAX_LEVEL=15; 
    let level=1,combo=0,maxCombo=0;
    const levelThresholds=[
        0,   30,  80, 150,  250, 
      350, 450, 550, 650,  750, 
      850, 950,1050,1150, 1250  
    ]; 
    let itemSpawnerId,gameBgParticleInterval,outerEffectInterval, gameTimerId;
    let isPowerUpActive=false,powerUpEndTime=0;
    let characterX,powerUpTimerId=null;
    let lastHelperIndex = -1;
    let isCharacterStunned = false; 
    let stunTimeoutId = null;       

    let isFeverModeActive = false;
    let feverModeEndTime = 0;
    let feverModeTimerId = null;
    let originalBGMVolume = 0.4; 
    let feverBGM;
    let seFeverStart; 
    let feverSpawnedLevel2 = false;
    let feverSpawnedByCombo60 = false; 
    const FEVER_DURATION = 6000; 
    let characterSpeedMultiplier = 1; 

    let seEggCollect,bgm,seTimePlus,seBomb,sePowerUp,seHelperMG, seHelperIkehaya, seHelperRoad, seLightning, seMakimonoGet;
    try{
      seEggCollect=new Audio("kirarin.mp3");
      bgm           =new Audio("main2.mp3");
      seTimePlus  =new Audio("tm.mp3");
      seBomb      =new Audio("bom.mp3");
      sePowerUp   =new Audio("st.mp3");
      seHelperMG  =new Audio("mg_chan_effect.mp3"); 
      seHelperIkehaya = new Audio("mg_chan_effect.mp3"); 
      seHelperRoad    = new Audio("mg_chan_effect.mp3"); 
      seLightning     = new Audio("lightning_strike.mp3");
      feverBGM = new Audio("fever_bgm.mp3"); 
      seFeverStart = new Audio("powerupGet.mp3"); 
      seMakimonoGet = new Audio("powerupGet.mp3"); 

      bgm.loop=true;bgm.volume=.3;
      feverBGM.loop = true; feverBGM.volume = 0.35; 
    }catch(e){
      console.error("Audio init error:",e);
      log("Audio init error: " + e.message); 
      const dummy={play:()=>{return Promise.resolve();},currentTime:0, pause:()=>{}}; 
      seEggCollect=seTimePlus=seBomb=sePowerUp=seHelperMG=seHelperIkehaya=seHelperRoad=seLightning=seMakimonoGet=dummy;
      bgm={play:()=>Promise.resolve(),pause:()=>{},loop:true,volume:.3};
      feverBGM = {play:()=>Promise.resolve(),pause:()=>{},loop:true,volume:0.35};
      seFeverStart = {play:()=>{return Promise.resolve();}};
    }
    try{highscore=parseInt(localStorage.getItem("rebornCatchHighscore"))||0}catch(e){}
    if(highscoreDisplay) highscoreDisplay.textContent=highscore; // nullチェック

    // 以下の関数は変更なし、または前回のデバッグコードのまま
    function createBgBubbleParticle(){ /* 実装済み */ }
    function createOuterShellParticle(){ /* 実装済み */ }
    function createInGameTwinkleStars(count = 50) { /* 前回のデバッグコード */ }
    const calcLevel=()=>Math.min(levelThresholds.filter(t=>score>=t).length,MAX_LEVEL);
    const spawnRate =()=>Math.max(150, (isFeverModeActive ? 400 : 700) - level * 40 ); 
    function updateScore(pt=1,type){ /* 前回のデバッグコード */ }
    const resetCombo=()=>{ /* 前回のコード */ };
    const showComboPopup=()=>{ /* 前回のコード */ };
    const showLevelUp=msg=>{ /* 前回のコード */ };
    const showSpecialEffect=()=>{ /* 前回のコード */ };
    function getCurrentCharacterScale() { /* 前回のコード */ }
    function activatePowerUp(){ /* 前回のデバッグコード */ }
    function deactivatePowerUp(){ /* 前回のデバッグコード */ }
    function spawnMakimonoItem() { /* 前回のデバッグコード */ }
    function handleItemCollection(itemElement) { /* 前回のデバッグコード */ }
    function createItem () { /* 前回のデバッグコード */ }
    // jump, 移動関連のリスナーも前回のデバッグコードから変更なし
    function jump(){ /* 前回のデバッグコード */ }

    function startGame(){
      try { 
        log("startGame: Entered");
        logElementState("gameContainer before characterX", gameContainer);
        characterX = gameContainer && gameContainer.offsetWidth ? gameContainer.offsetWidth / 2 : 150; 
        log(`startGame: characterX initialized to ${characterX}`);
        if(character) {
            character.style.left=characterX+"px";
            logElementState("character after initial positioning", character);
        }
        isCharacterStunned = false; 
        if (stunTimeoutId) clearTimeout(stunTimeoutId); stunTimeoutId = null;
        if(character) {
            character.classList.remove("electrocuted"); 
            character.style.removeProperty('--current-scale'); 
            character.classList.remove("powerup");
            character.style.transform = ''; 
            logElementState("character after class/style reset", character);
        }

        isFeverModeActive = false;
        if (feverModeTimerId) clearInterval(feverModeTimerId); feverModeTimerId = null;
        feverSpawnedLevel2 = false;
        feverSpawnedByCombo60 = false; 
        characterSpeedMultiplier = 1;
        if(gameContainer) gameContainer.classList.remove("fever-active");
        if(character) character.classList.remove("fever-character");
        
        if (feverBGM && typeof feverBGM.pause === 'function' && !feverBGM.paused) {
            feverBGM.pause();
            feverBGM.currentTime = 0;
        }
        if(bgm) originalBGMVolume = bgm.volume; 

        if(bgm && typeof bgm.play === 'function') {
            bgm.currentTime = 0; 
            bgm.play().catch(e => {log("BGM play error: "+e.message); console.error("BGM play error:", e)});
        }
        createInGameTwinkleStars(isFeverModeActive ? 80 : 50); 
        
        if (itemSpawnerId) clearInterval(itemSpawnerId); itemSpawnerId = null;
        itemSpawnerId=setInterval(createItem,spawnRate());
        
        if (gameBgParticleInterval) clearInterval(gameBgParticleInterval); gameBgParticleInterval = null;
        gameBgParticleInterval=setInterval(createBgBubbleParticle,700);

        if (outerEffectInterval) clearInterval(outerEffectInterval); outerEffectInterval = null;
        outerEffectInterval=setInterval(createOuterShellParticle,500);
        
        if (gameTimerId) clearInterval(gameTimerId); gameTimerId = null;
        gameTimerId=setInterval(()=>{
            try { // gameTimerIdのコールバック内にもtry-catch
                if(timeLeft<=0){
                    log("gameTimerId: timeLeft is 0 or less. Ending game.");
                    if (gameTimerId) clearInterval(gameTimerId); gameTimerId = null;
                    if (itemSpawnerId) clearInterval(itemSpawnerId); itemSpawnerId = null;
                    if (gameBgParticleInterval) clearInterval(gameBgParticleInterval); gameBgParticleInterval = null;
                    if (outerEffectInterval) clearInterval(outerEffectInterval); outerEffectInterval = null;
                    if(powerUpTimerId)clearInterval(powerUpTimerId); powerUpTimerId = null;
                    if (stunTimeoutId) clearTimeout(stunTimeoutId); stunTimeoutId = null;
                    if (feverModeTimerId) clearInterval(feverModeTimerId); feverModeTimerId = null;
                    endGame();return;
                }
                timeLeft--;
                if(timerDisplay) timerDisplay.textContent=timeLeft;
                if (!isCharacterStunned) {
                    if (itemSpawnerId) clearInterval(itemSpawnerId); // 再設定前にクリア
                    itemSpawnerId=setInterval(createItem,spawnRate());
                }
            } catch (timerError) {
                log(`Error in gameTimerId interval: ${timerError.message}`);
                console.error("Error in gameTimerId interval: ", timerError);
                if (gameTimerId) clearInterval(gameTimerId); gameTimerId = null; // エラー発生時もクリア
            }
        },1000);
        log("startGame: Finished");
      } catch (error) {
          log(`Error in startGame: ${error.message}`);
          console.error("Error in startGame: ", error);
      }
    }
    function endGame(){
      try { 
        log("endGame: Entered");
        if(bgm && typeof bgm.pause === 'function') bgm.pause();
        if (isFeverModeActive) {
            deactivateFeverMode(false); 
        }
        if (feverBGM && typeof feverBGM.pause === 'function' && !feverBGM.paused) {
            feverBGM.pause();
            feverBGM.currentTime = 0;
        }
        if(finalScore) finalScore.textContent=score;
        if(finalLevel) finalLevel.textContent=level;
        if(gameover) gameover.style.display="block";
        logElementState("gameover after display block", gameover);

        if(score>highscore){highscore=score;localStorage.setItem("rebornCatchHighscore",highscore);if(highscoreDisplay)highscoreDisplay.textContent=highscore}
        
        if(gameContainer) {
            const gameStars = gameContainer.querySelectorAll('.game-bg-star');
            gameStars.forEach(star => star.remove());
            log("endGame: Removed game stars.");

            const childrenToRemove = [...gameContainer.children].filter(c => 
                c && !["character","gameover","combo-display-popup","level-up-effect","power-effect", "fever-mode-display"].includes(c.id) &&
                (c.classList.contains("egg")||c.classList.contains("bomb")||c.classList.contains("power-up")||c.classList.contains("time-plus")||c.classList.contains("helper-mgchan")||c.classList.contains("helper-ikehaya")||c.classList.contains("helper-road")||c.classList.contains("lightning")||c.classList.contains("makimono")||c.classList.contains("bg-bubble-particle"))
            );
            log(`endGame: Found ${childrenToRemove.length} items to remove.`);
            childrenToRemove.forEach(c=>c.remove());
        }
        if(pageWrapper) {
            pageWrapper.querySelectorAll('.outer-shell-particle').forEach(e=>e.remove());
            log("endGame: Removed outer shell particles.");
        }
        if(returnToSelectBtn) returnToSelectBtn.onclick=()=>location.href="character_select.html"; 
        logElementState("character at end of endGame", character);
        log("endGame: Finished");
      } catch (error) {
          log(`Error in endGame: ${error.message}`);
          console.error("Error in endGame: ", error);
      }
    }

    document.addEventListener("keydown",e=>{ // 既存のまま
      if(timeLeft<=0 || isCharacterStunned)return;
      const w=character ? character.offsetWidth : 100; 
      const moveAmount = 30 * characterSpeedMultiplier; 
      if(e.key==="ArrowLeft"){characterX-=moveAmount}
      else if(e.key==="ArrowRight"){characterX+=moveAmount}
      else if(e.key===" "||e.key==="ArrowUp"){e.preventDefault();jump()}
      characterX = Math.max(w/2, Math.min((gameContainer ? gameContainer.offsetWidth : 380) - w/2, characterX)); 
      if(character) character.style.left=characterX+"px";
    });

    if(character) character.addEventListener("click",e=>{if(timeLeft>0 && !isCharacterStunned){e.preventDefault();jump()}},{passive:false});

    const leftBtn=document.createElement("button"),rightBtn=document.createElement("button");
    if (leftBtn && rightBtn && pageWrapper) { // 要素存在確認
        leftBtn.textContent="◀";rightBtn.textContent="▶";
        leftBtn.className=rightBtn.className="control-btn";
        leftBtn.style.left="20px";rightBtn.style.right="20px";
        pageWrapper.append(leftBtn,rightBtn);

        leftBtn.addEventListener("touchstart",e=>{e.preventDefault();if(!isCharacterStunned)startMove("left")},{passive:false});
        rightBtn.addEventListener("touchstart",e=>{e.preventDefault();if(!isCharacterStunned)startMove("right")},{passive:false});
        leftBtn.onmousedown=()=>{if(!isCharacterStunned)startMove("left")};
        rightBtn.onmousedown=()=>{if(!isCharacterStunned)startMove("right")};
        ["mouseup","touchend"].forEach(ev=>document.addEventListener(ev,stopMove,{passive:false}));
    }


    let moveInt=null;
    const startMove=dir=>{ // 既存のまま
      if(moveInt||timeLeft<=0 || isCharacterStunned)return;
      const w=character ? character.offsetWidth : 100;
      const baseMoveSpeed = 15;
      const moveAmount = baseMoveSpeed * characterSpeedMultiplier; 
      moveInt=setInterval(()=>{
        characterX+=(dir==="left"?-moveAmount:moveAmount);
        characterX = Math.max(w/2, Math.min((gameContainer ? gameContainer.offsetWidth : 380) - w/2, characterX));
        if(character) character.style.left=characterX+"px";
      },30);
    };
    const stopMove=()=>{if(moveInt)clearInterval(moveInt);moveInt=null};
    
    let sx=null,sy=null,thr=30;
    const relX=clX=>clX-(gameContainer ? gameContainer.getBoundingClientRect().left : 0); 
    if(gameContainer) { // 既存のまま
        gameContainer.addEventListener("touchstart",e=>{
            if(timeLeft<=0 || isCharacterStunned)return;
            const t=e.changedTouches[0];sx=relX(t.clientX);sy=t.clientY;
        },{passive:true});
        gameContainer.addEventListener("touchmove",e=>{
            const swipeMultiplier = isFeverModeActive ? 1.2 : 1; 
            if(timeLeft<=0||sx==null || isCharacterStunned)return;
            const x=relX(e.changedTouches[0].clientX),dx=(x-sx) * swipeMultiplier; characterX+=dx;sx=x;
            const w=character ? character.offsetWidth : 100;
            characterX = Math.max(w/2, Math.min((gameContainer ? gameContainer.offsetWidth : 380) - w/2, characterX));
            if(character) character.style.left=characterX+"px";
        },{passive:true});
        gameContainer.addEventListener("touchend",e=>{
            if(timeLeft<=0||sx==null||sy==null || isCharacterStunned){sx=sy=null;return}
            const dx=relX(e.changedTouches[0].clientX)-sx,dy=e.changedTouches[0].clientY-sy;
            if(Math.abs(dy)>Math.abs(dx)&&dy<-thr)jump();
            sx=sy=null;
        },{passive:true});
    }

    window.addEventListener('resize',()=>{ 
        const w=character ? character.offsetWidth : 100; 
        characterX = Math.max(w/2, Math.min((gameContainer ? gameContainer.offsetWidth : 380) - w/2, characterX)); 
        if(character) character.style.left=characterX+"px"; 
    });
    const tryPlay=()=>{ if(bgm && typeof bgm.play === 'function') bgm.play().then(()=>{ document.body.removeEventListener('click',tryPlay); document.body.removeEventListener('touchstart',tryPlay); }).catch(()=>{}); };
    document.body.addEventListener('click',tryPlay,{once:true});
    document.body.addEventListener('touchstart',tryPlay,{once:true});

    function checkAndSpawnFeverItem() { /* 前回のデバッグコード */ }
    function activateFeverMode() {
      try { 
        log("activateFeverMode: Entered");
        logElementState("character before activateFeverMode", character);
        logElementState("gameContainer before activateFeverMode", gameContainer);

        if (isFeverModeActive) {
            log("activateFeverMode: Fever mode already active, returning.");
            return;
        }
        isFeverModeActive = true;
        feverModeEndTime = Date.now() + FEVER_DURATION;

        seFeverStart?.play().catch(e => {log("Audio play error (seFeverStart): "+e.message); console.error("Audio play error:", e)});
        if(bgm && typeof bgm.pause === 'function') bgm.pause();
        if(feverBGM && typeof feverBGM.play === 'function') {
            feverBGM.currentTime = 0;
            feverBGM.play().catch(e => {log("Fever BGM play error: "+e.message); console.error("Fever BGM play error:", e)});
        }
        if(gameContainer) gameContainer.classList.add("fever-active");
        if(character) {
            character.classList.add("fever-character");
            character.style.transform = `translateX(-50%) scale(${getCurrentCharacterScale()})`; 
        }
        if(feverModeDisplay) feverModeDisplay.style.display = 'block';
        setTimeout(() => {
            if (feverModeDisplay) feverModeDisplay.style.display = 'none';
        }, 2500); 
        createInGameTwinkleStars(isFeverModeActive ? 80 : 50); 
        characterSpeedMultiplier = 1.6; 
        if(gameContainer) {
            const existingBombs = gameContainer.querySelectorAll(".bomb");
            existingBombs.forEach(bombNode => {
                bombNode.className = "egg golden fever-item-glow"; 
                bombNode.dataset.points = "10"; 
                bombNode.dataset.type = "feverBombPoints";
                bombNode.innerHTML = ''; 
                const dur = Math.max(1.5, 2.5 + Math.random() * 2 - level * 0.15);
                bombNode.style.animationDuration = dur + "s";
                bombNode.style.animationName = "fall-golden-egg"; 
            });
        }
        if(feverModeTimerId) clearInterval(feverModeTimerId); feverModeTimerId = null;
        feverModeTimerId = setInterval(() => {
            const timeLeftFever = Math.ceil((feverModeEndTime - Date.now()) / 1000);
            if (timeLeftFever <= 0 || timeLeft <= 0) {
                deactivateFeverMode();
            }
        }, 100);
        
        if(itemSpawnerId) clearInterval(itemSpawnerId); itemSpawnerId = null;
        itemSpawnerId = setInterval(createItem, spawnRate());
        log("activateFeverMode: Finished");
        logElementState("character after activateFeverMode", character);
        logElementState("gameContainer after activateFeverMode", gameContainer);
      } catch (error) {
          log(`Error in activateFeverMode: ${error.message} \nStack: ${error.stack}`);
          console.error("Error in activateFeverMode: ", error);
      }
    }

    function deactivateFeverMode(switchToMainBGM = true) {
      try { 
        log("deactivateFeverMode: Entered");
        logElementState("character before deactivateFeverMode", character);
        logElementState("gameContainer before deactivateFeverMode", gameContainer);

        if (!isFeverModeActive) {
            log("deactivateFeverMode: Fever mode not active, returning.");
            return;
        }
        isFeverModeActive = false;
        if(feverModeTimerId) clearInterval(feverModeTimerId); feverModeTimerId = null; 
        if (switchToMainBGM) {
            if(feverBGM && typeof feverBGM.pause === 'function') feverBGM.pause();
            if(bgm && typeof bgm.play === 'function') {
                bgm.volume = originalBGMVolume;
                bgm.currentTime = 0; 
                bgm.play().catch(e => {log("Main BGM resume error: "+e.message); console.error("Main BGM resume error:", e)});
            }
        }
        if(gameContainer) gameContainer.classList.remove("fever-active");
        if(character) {
            character.classList.remove("fever-character");
            character.style.transform = `translateX(-50%) scale(${getCurrentCharacterScale()})`; 
        }
        createInGameTwinkleStars(50);
        characterSpeedMultiplier = 1;
        
        if(itemSpawnerId) clearInterval(itemSpawnerId); itemSpawnerId = null;
        itemSpawnerId = setInterval(createItem, spawnRate());
        log("deactivateFeverMode: Finished");
        logElementState("character after deactivateFeverMode", character);
        logElementState("gameContainer after deactivateFeverMode", gameContainer);
      } catch (error) {
          log(`Error in deactivateFeverMode: ${error.message} \nStack: ${error.stack}`);
          console.error("Error in deactivateFeverMode: ", error);
      }
    }
    startGame();
  </script>
</body>
</html>
