<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CNP-CATCH</title>
  <style>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        å…±é€šãƒªã‚»ãƒƒãƒˆ & ãƒ•ã‚©ãƒ³ãƒˆ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
    body{
      width:100vw;height:100vh;overflow:hidden;
      font-family:'Noto Sans JP',sans-serif;
      touch-action:manipulation;-webkit-overflow-scrolling:touch;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #page-wrapper{
      width:100%;height:100%;
      background:#000;
      display:flex;justify-content:center;align-items:center;
      position:relative;overflow:hidden;
    }
    #game-container{
      position:relative;width:100%;max-width:380px;height:100%;
      background:#000;
      overflow:hidden;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .bg-bubble-particle{position:absolute;border-radius:50%;pointer-events:none;animation:float-bubble linear infinite;z-index:1;opacity:0}
    .bg-bubble-particle.yellow{background:rgba(255,215,0,.15)}
    .bg-bubble-particle.white{background:rgba(255,250,240,.12)}
    @keyframes float-bubble{
      0%{transform:translateY(105%) scale(var(--bubble-scale));opacity:0}
      20%,80%{opacity:var(--bubble-opacity)}
      100%{transform:translateY(-10%) scale(var(--bubble-scale));opacity:0}
    }
    .outer-shell-particle{
      position:absolute;pointer-events:none;opacity:0;z-index:5;
      background:rgba(245,222,179,.3);
      width:var(--shell-width);height:var(--shell-height);
      border-radius:30% 70% 20% 80%/50% 40% 60% 50%;
      animation:fall-outer-shell linear infinite;
    }
    @keyframes fall-outer-shell{
      0%{transform:translateY(-10vh) translateX(var(--outer-start-x)) rotateZ(0) rotateY(var(--outer-rotate-y-start));opacity:0}
      10%,90%{opacity:.5}
      100%{transform:translateY(110vh) translateX(var(--outer-end-x)) rotateZ(var(--outer-rotate-z-end)) rotateY(var(--outer-rotate-y-end));opacity:0}
    }

    @keyframes game-twinkle {
      0%, 100% { transform: scale(.3); opacity: 0; }
      10%      { opacity: .6; }
      50%      { opacity: .8; transform: scale(.5); }
      90%      { opacity: .6; }
    }
    .game-bg-star {
      position: absolute;
      width: 2px;
      height: 2px;
      border-radius: 50%;
      background: #fff;
      pointer-events: none;
      animation: game-twinkle 4s linear infinite;
      filter: drop-shadow(0 0 2px #fff) drop-shadow(0 0 4px #fff);
      z-index: 0;
    }


    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #character{
      position:absolute;bottom:80px;left:50%;
      transform:translateX(-50%) scale(1);
      max-height:20vh;max-width:100px;height:auto;z-index:50;
      filter:drop-shadow(2px 4px 8px rgba(0,0,0,.2));
      transition: transform .2s ease-out, filter .2s ease-out;
    }
    #character.jump{
        animation:jump-anim .6s ease;
    }
    #character.powerup{
      filter:drop-shadow(0 0 15px #FFD700) drop-shadow(2px 4px 8px rgba(0,0,0,.2));
      transform:translateX(-50%) scale(1.5);
    }
    @keyframes jump-anim{
      0% { transform: translateX(-50%) translateY(0) scale(var(--current-scale, 1)); }
      30%, 60% { transform: translateX(-50%) translateY(-60px) scale(var(--current-scale, 1)); }
      100% { transform: translateX(-50%) translateY(0) scale(var(--current-scale, 1)); }
    }
    #character.electrocuted {
      animation: electric-shock 0.08s infinite;
    }
    @keyframes electric-shock {
      0% { transform: translateX(-51%) rotate(-2deg) scale(var(--current-scale, 1)); }
      25% { transform: translateX(-49%) rotate(2deg) scale(var(--current-scale, 1)); }
      50% { transform: translateX(-51%) rotate(-1deg) scale(var(--current-scale, 1)); }
      75% { transform: translateX(-49%) rotate(1deg) scale(var(--current-scale, 1)); }
      100% { transform: translateX(-50%) rotate(0deg) scale(var(--current-scale, 1)); }
    }


    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ã‚¢ã‚¤ãƒ†ãƒ 
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* â˜… å…±é€šã‚¯ãƒ©ã‚¹ã« .fever-scroll ã‚’è¿½åŠ  */
    .egg,.bomb,.power-up,.time-plus,.helper-mgchan,.helper-ikehaya,.helper-road, .lightning, .fever-scroll {
      position:absolute;pointer-events:none;z-index:40;
      background-position:center;background-repeat:no-repeat;background-size:contain;
    }

    .egg{
      --start-rot-z: 0deg;
      --end-rot-z  : 0deg;
      background-color: #fff;
      width:30px;
      height:30px;
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      animation-name:fall-egg;animation-timing-function:linear;
      filter:drop-shadow(0 2px 2px rgba(0,0,0,.15));
    }
    .egg.special{
      background-color: #87CEEB;
      width:38px;
      height:38px;
      animation-name:fall-special-egg;animation-timing-function:linear;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,.2));
    }
    .egg.golden{
      background-color: #FFD700;
      width:46px;
      height:46px;
      animation-name:fall-golden-egg;animation-timing-function:linear;
      filter:drop-shadow(0 0 15px gold) drop-shadow(0 0 5px white);
    }

    .helper-mgchan{
      width:60px;height:60px;
      background-image:url("MG Chan.PNG");
      animation-name:fall-helper;animation-timing-function:linear;
      border-radius:15px;
      filter:drop-shadow(0 3px 5px rgba(0,0,0,.3));
    }
    .helper-ikehaya, .helper-road {
      width:60px;
      height:60px;
      animation-name:fall-helper;
      animation-timing-function:linear;
      border-radius:15px;
      filter:drop-shadow(0 3px 5px rgba(0,0,0,.3));
    }
    .helper-ikehaya {
      background-image:url("ikehaya.webp");
    }
    .helper-road {
      background-image:url("Road.webp");
    }

    .bomb{
      width:40px;height:40px;
      background:radial-gradient(circle,#5a3d32 0%,#3e2723 70%,#2d1b17 100%);
      border-radius:50%;
      filter:drop-shadow(0 0 10px rgba(40,20,10,.8));
      animation-name:fall-bomb;animation-timing-function:linear;
    }
    .bomb::before{
      content:'ğŸ’£';position:absolute;top:50%;left:50%;
      transform:translate(-50%,-50%);
      font-size:28px;color:#FF4500;text-shadow:0 0 5px #FF0000;
      animation:bomb-pulse .5s infinite alternate;
    }
    .power-up{
      width:45px;height:45px;border-radius:50%;
      background:linear-gradient(45deg,#FFD700,#FFA500,#FF8C00,#FF7F50,#FF6347);
      filter:drop-shadow(0 0 15px rgba(255,165,0,.8));
      animation:fall-powerup linear 1,var(--dummy,1s) ease infinite;
    }
    .power-up::before{
      content:'ğŸŒŸ';position:absolute;top:50%;left:50%;
      transform:translate(-50%,-50%);font-size:25px;
      animation:star-spin 1.5s linear infinite;
    }
    .time-plus{
      width:40px;height:40px;border-radius:50%;
      background:radial-gradient(circle,#F0E68C 0%,#EEE8AA 50%,#BDB76B 100%);
      filter:drop-shadow(0 0 8px rgba(218,165,32,.7));
      animation:fall-time-plus linear;
    }
    .time-plus::before{
      content:'â±ï¸';position:absolute;top:50%;left:50%;
      transform:translate(-50%,-50%);font-size:25px;
      animation:time-pulse 1.5s ease-in-out infinite alternate;
    }
    .lightning {
      width: 45px;
      height: 45px;
      font-size: 38px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #FFFF00;
      text-shadow: 0 0 5px #FFD700, 0 0 10px #FFEA00;
      animation-name: fall-bomb; 
      animation-timing-function: linear;
      filter: drop-shadow(0 0 8px gold);
    }
    .lightning::before {
      content: 'âš¡ï¸';
    }
    /* â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼å·»ç‰©ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .fever-scroll {
      width: 50px; /* ã‚µã‚¤ã‚ºã¯é©å®œèª¿æ•´ */
      height: 50px;
      background-image: url("makamio.webp"); /* å·»ç‰©ã®ç”»åƒã‚’æŒ‡å®š */
      animation-name: fall-helper; /* æ—¢å­˜ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æµç”¨ã€ã¾ãŸã¯å°‚ç”¨ã®ã‚’ä½œæˆ */
      animation-timing-function: linear;
      filter: drop-shadow(0 0 10px deeppink) drop-shadow(0 0 20px violet); /* ç‰¹åˆ¥ãªã‚ªãƒ¼ãƒ© */
    }

    /* UI CSSã¯å¤‰æ›´ãªã— */
    #scoreboard,#level-display,.control-btn,.power-effect,.combo-display,.level-up-effect{position:fixed;z-index:200}
    #scoreboard{top:15px;right:20px;font-size:14px;font-weight:bold;color:#604020;background:linear-gradient(145deg,#fff8dc 0%,#ffefd5 100%);padding:15px 20px;border-radius:20px;line-height:1.6;box-shadow:0 8px 24px rgba(0,0,0,.1),0 4px 8px rgba(139,69,19,.2);border:2px solid rgba(210,180,140,.5);backdrop-filter:blur(10px);min-width:180px;}
    #level-display{top:15px;left:20px;font-size:16px;font-weight:bold;color:#604020;background:linear-gradient(145deg,#fff8dc 0%,#ffefd5 100%);padding:12px 18px;border-radius:15px;box-shadow:0 4px 12px rgba(0,0,0,.1),0 2px 4px rgba(139,69,19,.2);border:2px solid rgba(210,180,140,.5);backdrop-filter:blur(5px);}
    .combo-display{top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;font-weight:bold;color:#FF8C00;background:rgba(60,30,10,.85);padding:10px 20px;border-radius:15px;display:none;animation:combo-pop 1s ease-out;text-shadow:1px 1px 2px rgba(255,255,255,.3);z-index:210;}
    #gameover{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:28px;font-weight:bold;background:linear-gradient(145deg,rgba(80,50,20,.9),rgba(50,30,10,.85));color:#fff8dc;padding:30px;border-radius:20px;display:none;z-index:150;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.5);border:2px solid rgba(210,180,140,.3);width:90%;max-width:380px;}
    #return-to-select-btn{background:#D2691E;color:#fff;border:none;padding:12px 25px;margin-top:25px;font-size:16px;border-radius:8px;cursor:pointer;transition:.3s;}
    #return-to-select-btn:hover{background:#A0522D}
    .control-btn{bottom:15px;width:55px;height:55px;font-size:22px;border-radius:50%;border:none;background:linear-gradient(145deg,rgba(210,180,140,.9) 0%,rgba(139,69,19,.8) 100%);color:#fff;cursor:pointer;box-shadow:0 6px 18px rgba(139,69,19,.4),0 3px 6px rgba(0,0,0,.2);border:2px solid rgba(255,255,255,.4);transition:.2s;}
    .control-btn:active{transform:scale(.95);box-shadow:0 3px 9px rgba(139,69,19,.4),0 1px 3px rgba(0,0,0,.2)}
    .power-effect{bottom:150px;left:20px;padding:8px 16px;font-size:14px;font-weight:bold;background:linear-gradient(45deg,#FFA500,#FF4500);color:#fff;border-radius:20px;display:none;animation:power-glow .5s ease-in-out infinite alternate;}
    .level-up-effect{top:30%;left:50%;transform:translate(-50%,-50%);font-size:32px;font-weight:bold;color:#CD853F;background:linear-gradient(45deg,rgba(255,228,181,.9),rgba(255,218,185,.8));padding:20px 40px;border-radius:20px;display:none;animation:level-up-animation 2s ease-out;text-shadow:1px 1px 2px rgba(100,50,0,.5);border:3px solid rgba(255,255,255,.8);z-index:210;}

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©ã¯å¤‰æ›´ãªã— */
    @keyframes bomb-pulse{0%{transform:translate(-50%,-50%) scale(1)}100%{transform:translate(-50%,-50%) scale(1.2)}}
    @keyframes star-spin{0%{transform:translate(-50%,-50%) rotate(0) scale(1)}50%{transform:translate(-50%,-50%) rotate(180deg) scale(1.2)}100%{transform:translate(-50%,-50%) rotate(360deg) scale(1)}}
    @keyframes rainbow-rotate-warm{0%{filter:drop-shadow(0 0 15px rgba(255,165,0,.8)) hue-rotate(0)}100%{filter:drop-shadow(0 0 15px rgba(255,165,0,.8)) hue-rotate(45deg)}}
    @keyframes power-glow{0%{box-shadow:0 0 10px rgba(255,165,0,.8)}100%{box-shadow:0 0 20px rgba(255,120,0,1)}}
    @keyframes level-up-animation{0%{transform:translate(-50%,-50%) scale(.5) rotate(-10deg);opacity:0}30%{transform:translate(-50%,-50%) scale(1.2) rotate(5deg);opacity:1}70%{transform:translate(-50%,-50%) scale(1.1) rotate(-2deg);opacity:1}100%{transform:translate(-50%,-50%) scale(1) rotate(0);opacity:0}}
    @keyframes time-pulse{0%{transform:translate(-50%,-50%) scale(1) rotate(0);opacity:.8}50%{transform:translate(-50%,-50%) scale(1.15) rotate(5deg);opacity:1}100%{transform:translate(-50%,-50%) scale(1) rotate(0);opacity:.8}}
    @keyframes fall-egg{0%{transform:translateY(-70px) rotateZ(var(--start-rot-z)) scale(.8);opacity:.6}100%{transform:translateY(105vh) rotateZ(var(--end-rot-z));opacity:1}}
    @keyframes fall-special-egg{0%{transform:translateY(-60px) rotateZ(0) scale(.9);opacity:.8}50%{transform:translateY(50vh) rotateZ(90deg) scale(1.1)}100%{transform:translateY(105vh) rotateZ(180deg) scale(.9);opacity:1}}
    @keyframes fall-golden-egg{0%{transform:translateY(-60px) rotateZ(0) scale(1);opacity:.9}25%{transform:translateY(25vh) rotateZ(var(--random-rotate-half)) scale(1.15)}100%{transform:translateY(105vh) rotateZ(var(--random-rotate)) scale(1);opacity:1}}
    @keyframes fall-helper{0%{transform:translateY(-80px) scale(.7) rotate(-15deg);opacity:.7}50%{transform:translateY(40vh) scale(1) rotate(15deg);opacity:1}100%{transform:translateY(105vh) scale(.8) rotate(5deg);opacity:.9}}
    @keyframes fall-bomb{0%{transform:translateY(-50px) rotate(0) scale(1);opacity:1}30%{transform:translateY(30vh) rotate(-20deg) scale(1.05)}60%{transform:translateY(60vh) rotate(15deg) scale(1.1)}100%{transform:translateY(100vh) rotate(10deg) scale(1);opacity:1}}
    @keyframes fall-powerup{0%{transform:translateY(-50px) scale(.8);opacity:.8}25%{transform:translateY(25vh) scale(1.1);opacity:1}50%{transform:translateY(50vh) scale(1.2)}75%{transform:translateY(75vh) scale(1.1)}100%{transform:translateY(100vh) scale(1);opacity:1}}
    @keyframes fall-time-plus{0%{transform:translateY(-50px) translateX(0) rotate(0) scale(.9);opacity:.7}25%{transform:translateY(25vh) translateX(10px) rotate(5deg) scale(1);opacity:1}50%{transform:translateY(50vh) translateX(-10px) rotate(-5deg) scale(1.1)}75%{transform:translateY(75vh) translateX(5px) rotate(2deg) scale(1)}100%{transform:translateY(100vh) translateX(0) rotate(0) scale(.9);opacity:1}}

  </style>
</head>
<body>
  <div id="page-wrapper">
    <div id="game-container">
      <img id="character" src="" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼">
      <div id="gameover">
        <div>ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</div>
        <div style="font-size:18px;margin-top:10px">
          æœ€çµ‚ã‚¹ã‚³ã‚¢:<span id="final-score">0</span><br>
          åˆ°é”ãƒ¬ãƒ™ãƒ«:<span id="final-level">1</span>
        </div>
        <button id="return-to-select-btn">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã«æˆ»ã‚‹</button>
      </div>
      <div class="combo-display" id="combo-display-popup"></div>
      <div class="level-up-effect" id="level-up-effect"></div>
      <div class="power-effect"  id="power-effect"></div>
    </div>
  </div>

  <div id="scoreboard">ã‚¹ã‚³ã‚¢:<span id="score">0</span><br>ãƒã‚¤ã‚¹ã‚³ã‚¢:<span id="highscore">0</span><br>æ®‹ã‚Š:<span id="timer">60</span>ç§’<br>ã‚³ãƒ³ãƒœ:<span id="combo">0</span></div>
  <div id="level-display">ãƒ¬ãƒ™ãƒ«:<span id="level">1</span></div>

  <script>
    document.addEventListener('contextmenu',e=>{e.preventDefault()},{passive:false});
    document.addEventListener('selectstart',e=>{e.preventDefault()},{passive:false});
    document.addEventListener('dragstart',e=>{e.preventDefault()},{passive:false});

    const pageWrapper          = document.getElementById("page-wrapper");
    const gameContainer        = document.getElementById("game-container");
    const character            = document.getElementById("character");
    const scoreDisplay         = document.getElementById("score");
    const highscoreDisplay     = document.getElementById("highscore");
    const timerDisplay         = document.getElementById("timer");
    const levelDisplay         = document.getElementById("level");
    const comboCountDisplay    = document.getElementById("combo");
    const comboPopup           = document.getElementById("combo-display-popup");
    const powerEffect          = document.getElementById("power-effect");
    const levelUpEffect        = document.getElementById("level-up-effect");
    const gameover             = document.getElementById("gameover");
    const finalScore           = document.getElementById("final-score");
    const finalLevel           = document.getElementById("final-level");
    const returnToSelectBtn    = document.getElementById("return-to-select-btn");

    const selectedImageFile = localStorage.getItem("selectedImage");
    const selectedCharName  = localStorage.getItem("selectedName");
    if(selectedImageFile && selectedCharName){
      character.src = selectedImageFile;
      character.alt = selectedCharName;
    }else{
      character.src = "Leeleeg.webp"; 
      character.alt = "Leelee";    
    }

    let score=0,highscore=0,timeLeft=60;
    const MAX_TIME_LEFT=90,MAX_LEVEL=5;
    let level=1,combo=0,maxCombo=0;
    const levelThresholds=[0,30,80,150,250]; // ãƒ¬ãƒ™ãƒ«0ã¯é–‹å§‹å‰, ãƒ¬ãƒ™ãƒ«1é–¾å€¤30...
    let itemSpawnerId,gameBgParticleInterval,outerEffectInterval, gameTimerId;
    let isPowerUpActive=false,powerUpEndTime=0;
    let characterX,powerUpTimerId=null;
    let lastHelperIndex = -1;
    let isCharacterStunned = false; 
    let stunTimeoutId = null;       
    
    // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰é–¢é€£ã®å¤‰æ•°
    let isFeverActive = false;
    let feverEndTime = 0;
    let feverTimeoutId = null;
    let hasFeverLevel2Spawned = false;
    let hasFeverLevel5Spawned = false;
    const FEVER_DURATION = 10000; // ãƒ•ã‚£ãƒ¼ãƒãƒ¼æ™‚é–“10ç§’ (ãƒŸãƒªç§’)

    // â˜… åŠ¹æœéŸ³ãƒ»BGMç”¨å¤‰æ•° (ãƒ•ã‚£ãƒ¼ãƒãƒ¼ç”¨ã‚‚è¿½åŠ )
    let seEggCollect,bgm,bgmFever,seTimePlus,seBomb,sePowerUp,seHelperMG, seHelperIkehaya, seHelperRoad, seLightning, seFeverGet, seFeverStart, seFeverEnd;
    try{
      seEggCollect=new Audio("kirarin.mp3");
      bgm           =new Audio("main2.mp3");
      bgmFever      =new Audio("fever_bgm.mp3"); // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼ç”¨BGM (ä»®ã®ãƒ•ã‚¡ã‚¤ãƒ«å)
      seTimePlus  =new Audio("tm.mp3");
      seBomb      =new Audio("bom.mp3");
      sePowerUp   =new Audio("st.mp3");
      seHelperMG  =new Audio("mg_chan_effect.mp3"); 
      seHelperIkehaya = new Audio("mg_chan_effect.mp3"); 
      seHelperRoad    = new Audio("mg_chan_effect.mp3"); 
      seLightning     = new Audio("lightning_strike.mp3"); 
      seFeverGet      = new Audio("fever_get.mp3"); // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¢ã‚¤ãƒ†ãƒ å–å¾—éŸ³ (ä»®)
      seFeverStart    = new Audio("fever_start.mp3"); // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼é–‹å§‹éŸ³ (ä»®)
      seFeverEnd      = new Audio("fever_end.mp3"); // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼çµ‚äº†éŸ³ (ä»®)
      bgm.loop=true;bgm.volume=.3;
      bgmFever.loop=true;bgmFever.volume=.4; // ãƒ•ã‚£ãƒ¼ãƒãƒ¼BGMã‚‚ãƒ«ãƒ¼ãƒ—ãƒ»éŸ³é‡è¨­å®š
    }catch(e){
      console.error("Audio init error:",e);
      const dummy={play:()=>{return Promise.resolve()},pause:()=>{},currentTime:0,loop:false,volume:0}; // Promiseã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£
      seEggCollect=seTimePlus=seBomb=sePowerUp=seHelperMG=seHelperIkehaya=seHelperRoad=seLightning=seFeverGet=seFeverStart=seFeverEnd=dummy;
      bgm=bgmFever=dummy;
    }
    try{highscore=parseInt(localStorage.getItem("rebornCatchHighscore"))||0}catch(e){}
    highscoreDisplay.textContent=highscore;

    function createBgBubbleParticle(){ /* å®Ÿè£…æ¸ˆã¿ */ }
    function createOuterShellParticle(){ /* å®Ÿè£…æ¸ˆã¿ */ }
    function createInGameTwinkleStars(count = 50) { /* å®Ÿè£…æ¸ˆã¿ */ }

    const calcLevel=()=>Math.min(levelThresholds.filter(t=>score>=t).length,MAX_LEVEL);
    const spawnRate =()=> {
        if (isFeverActive) return Math.max(100, 300 - level * 20); // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯å°‘ã—æ—©ã‚ã«
        return Math.max(150,700-level*40);
    }

    // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¢ã‚¤ãƒ†ãƒ å‡ºç¾æ¡ä»¶ãƒã‚§ãƒƒã‚¯ã¨ç”Ÿæˆãƒˆãƒªã‚¬ãƒ¼
    function trySpawnFeverScroll() {
        if (isFeverActive) return; // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯å‡ºç¾ã—ãªã„

        if (level === 2 && combo >= 15 && !hasFeverLevel2Spawned) {
            hasFeverLevel2Spawned = true;
            forceSpawnItem("feverScroll");
        } else if (level === 5 && combo >= 60 && !hasFeverLevel5Spawned) {
            hasFeverLevel5Spawned = true;
            forceSpawnItem("feverScroll");
        }
    }
    // â˜… ç‰¹å®šã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å¼·åˆ¶çš„ã«ç”Ÿæˆã™ã‚‹é–¢æ•° (createItemã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¸€éƒ¨åˆ©ç”¨)
    function forceSpawnItem(itemType) {
        const item = document.createElement("div");
        let w;
        // (ãƒ•ã‚£ãƒ¼ãƒãƒ¼å·»ç‰©ã®è¨­å®šã¯createItemå†…ã§è¡Œã†ã®ã§ã€ã“ã“ã§ã¯classNameç¨‹åº¦ã§è‰¯ã„ã‹ã€createItemã«typeã‚’æ¸¡ã™)
        // ç°¡å˜ã®ãŸã‚ã€æ¬¡ã®createItemã§å¿…ãšãƒ•ã‚£ãƒ¼ãƒãƒ¼å·»ç‰©ãŒå‡ºã‚‹ã‚ˆã†ã«ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹
        // ä»Šå›ã¯ç›´æ¥ç”Ÿæˆã—ã¦ã¿ã‚‹
        item.className = "fever-scroll";
        item.dataset.type = itemType;
        w = 50; // CSSã§å®šç¾©ã—ãŸãƒ•ã‚£ãƒ¼ãƒãƒ¼å·»ç‰©ã®å¹…

        const dur = Math.max(1.5, 2.5 + Math.random() * 2 - level * 0.15);
        item.style.left = Math.random() * (gameContainer.offsetWidth - w) + "px";
        item.style.animationDuration = dur + "s";
        item.style.animationName = "fall-helper"; // ä»®ã®è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

        gameContainer.appendChild(item);
        // è¡çªåˆ¤å®šã¨å‰Šé™¤ã¯createItemå†…ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…±é€šåŒ–ã™ã‚‹ã‹ã€åˆ¥é€”å®šç¾©ãŒå¿…è¦
        // ä»Šå›ã¯createItemå†…ã®æŠ½é¸ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹å½¢ã§ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç”Ÿæˆã™ã‚‹æ–¹é‡ã«å¤‰æ›´ã—ã¾ã™ã€‚
        // ã“ã®forceSpawnItemã¯ä½¿ã‚ãšã€createItemå†…ã§æ¡ä»¶ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã‚’å„ªå…ˆç”Ÿæˆã—ã¾ã™ã€‚
    }


    function updateScore(pt=1,type){
      if(isPowerUpActive && !isFeverActive)pt*=2; // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã®2å€ã‚’é‡è¤‡ã•ã›ãªã„ã‹è¦æ¤œè¨
      if(isFeverActive && type.includes("egg")) pt = 5; // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯æ˜Ÿã®å¾—ç‚¹ã‚’5ç‚¹ã« (ä»®)

      score+=pt;
      combo++;
      scoreDisplay.textContent=score;
      comboCountDisplay.textContent=combo;
      const prevLevel=level;level=calcLevel();levelDisplay.textContent=level; // prev -> prevLevel
      if(level>prevLevel)showLevelUp(level===MAX_LEVEL?`MAX LEVEL ${MAX_LEVEL} åˆ°é”!`:`LEVEL ${level}!`);
      if(combo>1)showComboPopup();
      if(pt>=5 && (type==="egg golden"))showSpecialEffect();
      if(combo>maxCombo)maxCombo=combo;

      trySpawnFeverScroll(); // â˜… ã‚¹ã‚³ã‚¢æ›´æ–°(ã‚³ãƒ³ãƒœå¢—åŠ )ã®ãŸã³ã«ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¢ã‚¤ãƒ†ãƒ å‡ºç¾æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
    }
    const resetCombo=()=>{combo=0;comboCountDisplay.textContent=combo};
    const showComboPopup=()=>{comboPopup.textContent=`${combo} COMBO!`;comboPopup.style.display='block';setTimeout(()=>comboPopup.style.display='none',1000)};
    const showLevelUp=msg=>{levelUpEffect.textContent=msg;levelUpEffect.style.display='block';setTimeout(()=>levelUpEffect.style.display='none',2000)};
    const showSpecialEffect=()=>{scoreDisplay.style.cssText="transform:scale(1.3);color:#D4AF37";setTimeout(()=>scoreDisplay.style.cssText="",500)};

    // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰é–‹å§‹å‡¦ç†
    function activateFeverMode() {
        if (isFeverActive) return; // ã™ã§ã«ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
        isFeverActive = true;
        feverEndTime = Date.now() + FEVER_DURATION;
        seFeverStart?.play().catch(()=>{});

        // BGMå¤‰æ›´
        bgm.pause();
        bgmFever.currentTime = 0;
        bgmFever.play().catch(()=>{});

        // ç”»é¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ (ä¾‹: game-containerã®ã‚¯ãƒ©ã‚¹ã‚’å¤‰æ›´ã—ã¦CSSã§å¯¾å¿œ)
        gameContainer.classList.add("fever-active-bg"); // CSSã§ .fever-active-bg ã‚’å®šç¾©

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç§»å‹•é€Ÿåº¦ã‚¢ãƒƒãƒ— (å…ƒã®é€Ÿåº¦ã‚’ä¿å­˜ã—ã¦ãŠãå¿…è¦ã‚ã‚Š)
        // ã“ã®éƒ¨åˆ†ã¯æ“ä½œç³»ã® startMove ç­‰ã‚’èª¿æ•´

        powerEffect.textContent = "FEVER TIME!"; // è¡¨ç¤ºã‚’ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã«
        powerEffect.style.background = "linear-gradient(45deg, deeppink, violet, cyan)"; // è‰²ã‚‚å¤‰ãˆã‚‹
        powerEffect.style.display = 'block';


        feverTimeoutId = setTimeout(deactivateFeverMode, FEVER_DURATION);
    }

    // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰çµ‚äº†å‡¦ç†
    function deactivateFeverMode() {
        isFeverActive = false;
        seFeverEnd?.play().catch(()=>{});

        // BGMã‚’å…ƒã«æˆ»ã™
        bgmFever.pause();
        bgm.currentTime = 0; // ã¾ãŸã¯ä¸­æ–­ç®‡æ‰€ã‹ã‚‰å†ç”Ÿ
        bgm.play().catch(()=>{});

        // ç”»é¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å…ƒã«æˆ»ã™
        gameContainer.classList.remove("fever-active-bg");

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç§»å‹•é€Ÿåº¦ã‚’å…ƒã«æˆ»ã™

        // powerEffect ã®è¡¨ç¤ºã‚’å…ƒã«æˆ»ã™ã‹éè¡¨ç¤ºã«
        if (isPowerUpActive) { // ã‚‚ã—ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚‚åŒæ™‚ã«ã‹ã‹ã£ã¦ã„ãŸã‚‰ãã¡ã‚‰ã®è¡¨ç¤ºã«æˆ»ã™
            // activatePowerUpå†…ã®ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã‚’å†å®Ÿè¡Œã™ã‚‹ã‹ã€è¡¨ç¤ºã‚’æ›´æ–°
             powerEffect.textContent = `ğŸ¥šã‚¹ã‚³ã‚¢ï¼’å€ï¼(${Math.ceil((powerUpEndTime-Date.now())/1000)}s)`;
             powerEffect.style.background = "linear-gradient(45deg,#FFA500,#FF4500)";
        } else {
            powerEffect.style.display = 'none';
        }
        if (feverTimeoutId) clearTimeout(feverTimeoutId);
    }


    function activatePowerUp(){
      if(isPowerUpActive){
        powerUpEndTime+=10000; 
        clearInterval(powerUpTimerId); 
      } else {
        isPowerUpActive=true;
        powerUpEndTime=Date.now()+10000;
        character.classList.add("powerup"); 
        if (!isFeverActive) powerEffect.style.display='block'; // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯ãƒ•ã‚£ãƒ¼ãƒãƒ¼è¡¨ç¤ºå„ªå…ˆ
      }
      powerUpTimerId=setInterval(()=>{
        const remain=Math.ceil((powerUpEndTime-Date.now())/1000);
        if(remain<=0){deactivatePowerUp();clearInterval(powerUpTimerId)}
        else if (!isFeverActive) powerEffect.textContent=`ğŸ¥šã‚¹ã‚³ã‚¢ï¼’å€ï¼(${remain}s)`;
      },100);
    }
    function deactivatePowerUp(){
      isPowerUpActive=false;
      character.classList.remove("powerup"); 
      if (!isFeverActive) powerEffect.style.display='none';
      clearInterval(powerUpTimerId);
      if (!character.classList.contains("electrocuted") && !isFeverActive) {
         character.style.transform = 'translateX(-50%) scale(1)';
      }
    }

    function createItem () {
      if (timeLeft <= 0) return;

      // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¢ã‚¤ãƒ†ãƒ å‡ºç¾åˆ¤å®š (trySpawnFeverScrollã‹ã‚‰ã“ã¡ã‚‰ã«ç§»å‹•)
      let forceFeverScroll = false;
      if (!isFeverActive) { // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã§ãªã„å ´åˆã®ã¿å‡ºç¾åˆ¤å®š
          if (level === 2 && combo >= 15 && !hasFeverLevel2Spawned) {
              hasFeverLevel2Spawned = true;
              forceFeverScroll = true;
          } else if (level === 5 && combo >= 60 && !hasFeverLevel5Spawned) {
              hasFeverLevel5Spawned = true;
              forceFeverScroll = true;
          }
      }
      
      let type;
      if (forceFeverScroll) {
          type = "feverScroll";
      } else if (isFeverActive) {
          // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯é‡‘ã®æ˜Ÿã®ã¿ã€çˆ†å¼¾ãªã—
          type = "egg golden"; // å¼·åˆ¶çš„ã«é‡‘ã®æ˜Ÿ
      } else {
          // é€šå¸¸æ™‚ã®ã‚¢ã‚¤ãƒ†ãƒ æŠ½é¸
          const r = Math.random();
          const prob = { bomb: 0, timePlus: .08, powerUp: 0, helper: .06, gold: .10, special: .15, lightning: .05 };
          if (level >= 2) {
            prob.bomb    = Math.min(.05 + (level - 2) * .03, .14);
            prob.powerUp = .07;
            prob.lightning = Math.min(.05 + (level - 2) * .01, .08);
          }
          let sum  = 0;
          type = "normalEgg"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
          const pick = (p, t) => { sum += p; if(r < sum && type === "normalEgg") type = t; return r < sum; };

          pick(prob.bomb,   "bomb"      ) ||
          pick(prob.timePlus,"timePlus") ||
          pick(prob.powerUp,"powerup"   ) ||
          pick(prob.helper, "helper"    ) ||
          pick(prob.lightning, "lightning") ||
          pick(prob.gold,   "egg golden") ||
          pick(prob.special,"egg special");
      }


      const item = document.createElement("div");
      let w;
      let currentHelperType = "";

      if (type === "helper") {
        const helpers = ["helperIkehaya", "helperRoad"];
        lastHelperIndex = (lastHelperIndex + 1) % helpers.length;
        currentHelperType = helpers[lastHelperIndex];
        type = currentHelperType; // typeã‚’å…·ä½“çš„ãªãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¿ã‚¤ãƒ—ã§ä¸Šæ›¸ã
      }

      switch (type) {
        case "bomb"         : if (isFeverActive) { type = "egg golden"; item.className = "egg golden"; item.dataset.points = "5"; w = 46; } // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯çˆ†å¼¾ã‚‚é‡‘ã®æ˜Ÿã«
                              else { item.className = "bomb"; item.dataset.points = "-10"; w = 40; } break;
        case "timePlus"     : item.className = "time-plus";      item.dataset.points = "0";   w = 40; break;
        case "powerup"      : item.className = "power-up";       item.dataset.points = "0";   w = 45; break;
        case "helperIkehaya": item.className = "helper-ikehaya"; item.dataset.points = "25";  w = 60; break;
        case "helperRoad"   : item.className = "helper-road";    item.dataset.points = "25";  w = 60; break;
        case "lightning"    : item.className = "lightning";      item.dataset.points = "0";   w = 45; break;
        case "feverScroll"  : item.className = "fever-scroll";   item.dataset.points = "0";   w = 50; break; // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼å·»ç‰©ã®å®šç¾©
        case "egg golden"   : item.className = "egg golden";     item.dataset.points = "5";   w = 46; break;
        case "egg special"  : item.className = "egg special";    item.dataset.points = "2";   w = 38; break;
        default             : item.className = "egg";             item.dataset.points = "1";   w = 30; type = "normalEgg";
      }
      item.dataset.type = type;

      const dur = Math.max(1.5, 2.5 + Math.random() * 2 - level * 0.15 - (isFeverActive ? 0.5 : 0) ); // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯å°‘ã—é€Ÿã
      item.style.left            = Math.random() * (gameContainer.offsetWidth - w) + "px";
      item.style.animationDuration = dur + "s";
      item.style.animationName =
            type === "egg special" ? "fall-special-egg" :
            type === "egg golden"  ? "fall-golden-egg"  :
            type.startsWith("helper") ? "fall-helper" :
            type === "lightning" ? "fall-bomb" :
            type === "feverScroll" ? "fall-helper" : // ãƒ•ã‚£ãƒ¼ãƒãƒ¼å·»ç‰©ã‚‚ãƒ˜ãƒ«ãƒ‘ãƒ¼ã¨åŒã˜è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»®ä½¿ç”¨
            "fall-egg";

      item.style.setProperty("--start-rot-z",  ((Math.random() - .5) * 60).toFixed(1) + "deg");
      item.style.setProperty("--end-rot-z",    ((Math.random() - .5) * 90).toFixed(1) + "deg");
      item.style.setProperty("--random-rotate",      ((Math.random() - .5) * 70).toFixed(1) + "deg");
      item.style.setProperty("--random-rotate-half", ((Math.random() - .5) * 35).toFixed(1) + "deg");

      gameContainer.appendChild(item);

      const hit = setInterval(() => {
        if (!item.parentNode || timeLeft <= 0) { clearInterval(hit); item.remove(); return; }
        const a = item.getBoundingClientRect();
        const b = character.getBoundingClientRect();
        if (a.top < b.bottom && a.bottom > b.top && a.left < b.right && a.right > b.left) {
          const pts = parseInt(item.dataset.points) || 0;
          switch (item.dataset.type) {
            case "bomb": // ã“ã®ã‚±ãƒ¼ã‚¹ã¯ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯åˆ°é”ã—ãªã„ã¯ãš
              score = Math.max(0, score + pts);
              scoreDisplay.textContent = score;
              resetCombo();
              seBomb?.play().catch(()=>{});
              gameContainer.style.background = "rgba(150,50,50,.7)";
              setTimeout(() => { gameContainer.style.background = "#000"; }, 150);
              break;
            case "timePlus":
              if (isFeverActive) { updateScore(5, item.dataset.type); } // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯5ç‚¹
              else { timeLeft = Math.min(timeLeft + 5, MAX_TIME_LEFT); timerDisplay.textContent = timeLeft; }
              seTimePlus?.play().catch(()=>{});
              break;
            case "powerup":
              if (isFeverActive) { updateScore(5, item.dataset.type); } // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯5ç‚¹
              else { activatePowerUp(); }
              sePowerUp?.play().catch(()=>{});
              break;
            case "helperIkehaya":
            case "helperRoad":
              updateScore(isFeverActive ? 5 : pts, item.dataset.type); // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯5ç‚¹
              seHelperMG?.play().catch(()=>{}); 
              [...gameContainer.querySelectorAll(".bomb")].slice(0, 2).forEach(b => b.remove());
              break;
            case "lightning":
              if (isFeverActive) { updateScore(5, item.dataset.type); } // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯5ç‚¹
              else {
                seLightning?.play().catch(()=>{});
                if (!isCharacterStunned) {
                  isCharacterStunned = true;
                  const currentScaleValue = character.classList.contains("powerup") ? 1.5 : 1;
                  character.style.setProperty('--current-scale', currentScaleValue);
                  character.classList.add("electrocuted");
                  if (stunTimeoutId) clearTimeout(stunTimeoutId);
                  stunTimeoutId = setTimeout(() => {
                    isCharacterStunned = false;
                    character.classList.remove("electrocuted");
                    character.style.removeProperty('--current-scale');
                    if (character.classList.contains("powerup")) {
                       character.style.transform = 'translateX(-50%) scale(1.5)';
                    } else {
                       character.style.transform = 'translateX(-50%) scale(1)';
                    }
                  }, 3000);
                }
              }
              break;
            // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼å·»ç‰©ã‚’å–å¾—ã—ãŸæ™‚ã®å‡¦ç†
            case "feverScroll":
              seFeverGet?.play().catch(()=>{});
              activateFeverMode();
              break;
            default: // egg, egg special, egg golden (normalEggå«ã‚€)
              updateScore(pts, item.dataset.type); // updateScoreå†…ã§ãƒ•ã‚£ãƒ¼ãƒãƒ¼æ™‚ã®å¾—ç‚¹èª¿æ•´
              seEggCollect?.play().catch(()=>{});
          }
          item.remove();
          clearInterval(hit);
        }
      }, 30);

      setTimeout(() => {
        if (item.parentNode) {
          item.remove();
          if (item.classList.contains("egg")) resetCombo();
        }
        clearInterval(hit);
      }, dur * 1000 + 300);
    }

    function startGame(){
      characterX=gameContainer.offsetWidth/2;character.style.left=characterX+"px";
      isCharacterStunned = false; 
      if (stunTimeoutId) clearTimeout(stunTimeoutId); 
      character.classList.remove("electrocuted"); 
      character.style.removeProperty('--current-scale'); 

      character.classList.remove("powerup");
      character.style.transform = 'translateX(-50%) scale(1)';

      // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼é–¢é€£ãƒ•ãƒ©ã‚°åˆæœŸåŒ–
      isFeverActive = false;
      if (feverTimeoutId) clearTimeout(feverTimeoutId);
      hasFeverLevel2Spawned = false;
      hasFeverLevel5Spawned = false;
      bgmFever.pause(); // å¿µã®ãŸã‚ãƒ•ã‚£ãƒ¼ãƒãƒ¼BGMã‚‚åœæ­¢
      bgmFever.currentTime = 0;
      gameContainer.classList.remove("fever-active-bg");


      bgm.play().catch(()=>{});
      createInGameTwinkleStars(50); 
      itemSpawnerId=setInterval(createItem,spawnRate());
      gameBgParticleInterval=setInterval(createBgBubbleParticle,700);
      outerEffectInterval=setInterval(createOuterShellParticle,500);
      gameTimerId=setInterval(()=>{
        if(timeLeft<=0){
          clearInterval(gameTimerId);clearInterval(itemSpawnerId);
          clearInterval(gameBgParticleInterval);clearInterval(outerEffectInterval);
          if(powerUpTimerId)clearInterval(powerUpTimerId);
          if (stunTimeoutId) clearTimeout(stunTimeoutId);
          if (feverTimeoutId) clearTimeout(feverTimeoutId); // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¿ã‚¤ãƒãƒ¼ã‚‚ã‚¯ãƒªã‚¢
          deactivateFeverMode(); // å¿µã®ãŸã‚ãƒ•ã‚£ãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚‚è§£é™¤
          endGame();return;
        }
        timeLeft--;timerDisplay.textContent=timeLeft;
        // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯ã‚¹ãƒãƒ¼ãƒ³ãƒ¬ãƒ¼ãƒˆãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€æ¯å›ã‚¯ãƒªã‚¢ã—ã¦å†è¨­å®š
        clearInterval(itemSpawnerId);itemSpawnerId=setInterval(createItem,spawnRate());
        
      },1000);
    }
    function endGame(){
      bgm.pause();
      bgmFever.pause(); // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼BGMã‚‚åœæ­¢
      finalScore.textContent=score;finalLevel.textContent=level;
      gameover.style.display="block";
      if(score>highscore){highscore=score;localStorage.setItem("rebornCatchHighscore",highscore);highscoreDisplay.textContent=highscore}
      
      const gameStars = gameContainer.querySelectorAll('.game-bg-star');
      gameStars.forEach(star => star.remove());

      [...gameContainer.children].forEach(c=>{
        if(!["character","gameover","combo-display-popup","level-up-effect","power-effect"].includes(c.id)){
          // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼å·»ç‰©ã‚‚å‰Šé™¤å¯¾è±¡ã«
          if(c.classList.contains("egg")||c.classList.contains("bomb")||c.classList.contains("power-up")||c.classList.contains("time-plus")||c.classList.contains("helper-mgchan")||c.classList.contains("helper-ikehaya")||c.classList.contains("helper-road")||c.classList.contains("lightning")||c.classList.contains("fever-scroll")||c.classList.contains("bg-bubble-particle"))c.remove();
        }
      });
      pageWrapper.querySelectorAll('.outer-shell-particle').forEach(e=>e.remove());
      returnToSelectBtn.onclick=()=>location.href="character_select.html"; 
    }

    document.addEventListener("keydown",e=>{
      if(timeLeft<=0 || isCharacterStunned)return;
      const moveSpeed = isFeverActive ? 45 : 30; // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯ç§»å‹•é€Ÿåº¦ã‚¢ãƒƒãƒ—
      const w=character.offsetWidth||120;
      if(e.key==="ArrowLeft"){characterX-=moveSpeed}
      else if(e.key==="ArrowRight"){characterX+=moveSpeed}
      else if(e.key===" "||e.key==="ArrowUp"){e.preventDefault();jump()}
      characterX=Math.max(w/2,Math.min(gameContainer.offsetWidth-w/2,characterX));
      character.style.left=characterX+"px";
    });
    function jump(){ 
      if(character.classList.contains("jump")||timeLeft<=0 || isCharacterStunned)return;
      const currentScaleValue = character.classList.contains("powerup") ? 1.5 : 1;
      character.style.setProperty('--current-scale', currentScaleValue);
      character.classList.add("jump");
      setTimeout(()=>{
          character.classList.remove("jump");
          character.style.removeProperty('--current-scale'); 
      },600);
    }
    character.addEventListener("click",e=>{if(timeLeft>0 && !isCharacterStunned){e.preventDefault();jump()}},{passive:false});


    const leftBtn=document.createElement("button"),rightBtn=document.createElement("button");
    leftBtn.textContent="â—€";rightBtn.textContent="â–¶";
    leftBtn.className=rightBtn.className="control-btn";
    leftBtn.style.left="20px";rightBtn.style.right="20px";
    pageWrapper.append(leftBtn,rightBtn);

    let moveInt=null;
    const startMove=dir=>{
      if(moveInt||timeLeft<=0 || isCharacterStunned)return;
      const moveSpeed = isFeverActive ? 22 : 15; // â˜… ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯ç§»å‹•é€Ÿåº¦ã‚¢ãƒƒãƒ—
      const w=character.offsetWidth||120;
      moveInt=setInterval(()=>{
        characterX+=(dir==="left"?-moveSpeed:moveSpeed);
        characterX=Math.max(w/2,Math.min(gameContainer.offsetWidth-w/2,characterX));
        character.style.left=characterX+"px";
      },30);
    };
    const stopMove=()=>{clearInterval(moveInt);moveInt=null};
    leftBtn.addEventListener("touchstart",e=>{e.preventDefault();if(!isCharacterStunned)startMove("left")},{passive:false});
    rightBtn.addEventListener("touchstart",e=>{e.preventDefault();if(!isCharacterStunned)startMove("right")},{passive:false});
    leftBtn.onmousedown=()=>{if(!isCharacterStunned)startMove("left")};
    rightBtn.onmousedown=()=>{if(!isCharacterStunned)startMove("right")};
    ["mouseup","touchend"].forEach(ev=>document.addEventListener(ev,stopMove,{passive:false}));

    let sx=null,sy=null,thr=30;
    const relX=cl=>cl-gameContainer.getBoundingClientRect().left;
    gameContainer.addEventListener("touchstart",e=>{
      if(timeLeft<=0 || isCharacterStunned)return;
      const t=e.changedTouches[0];sx=relX(t.clientX);sy=t.clientY;
    },{passive:true});
    gameContainer.addEventListener("touchmove",e=>{ // â˜… ã‚¹ãƒ¯ã‚¤ãƒ—ç§»å‹•ã‚‚ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã§é€Ÿåº¦ã‚¢ãƒƒãƒ—ã•ã›ã‚‹ãªã‚‰èª¿æ•´
      if(timeLeft<=0||sx==null || isCharacterStunned)return;
      const x=relX(e.changedTouches[0].clientX);
      let dx=x-sx;
      if(isFeverActive) dx *= 1.5; // ä¾‹: ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯ã‚¹ãƒ¯ã‚¤ãƒ—æ„Ÿåº¦1.5å€
      characterX+=dx;
      sx=x;
      const w=character.offsetWidth||120;
      characterX=Math.max(w/2,Math.min(gameContainer.offsetWidth-w/2,characterX));
      character.style.left=characterX+"px";
    },{passive:true});
    gameContainer.addEventListener("touchend",e=>{
      if(timeLeft<=0||sx==null||sy==null || isCharacterStunned){sx=sy=null;return}
      const dx=relX(e.changedTouches[0].clientX)-sx,dy=e.changedTouches[0].clientY-sy;
      if(Math.abs(dy)>Math.abs(dx)&&dy<-thr)jump();
      sx=sy=null;
    },{passive:true});

    window.addEventListener('resize',()=>{ const w=character.offsetWidth||120; characterX=Math.max(w/2,Math.min(gameContainer.offsetWidth-w/2,characterX)); character.style.left=characterX+"px"; });
    const tryPlay=()=>{ bgm.play().then(()=>{ document.body.removeEventListener('click',tryPlay); document.body.removeEventListener('touchstart',tryPlay); }).catch(()=>{}); };
    document.body.addEventListener('click',tryPlay,{once:true});
    document.body.addEventListener('touchstart',tryPlay,{once:true});

    startGame();
  </script>
</body>
</html>
